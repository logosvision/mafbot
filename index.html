<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ĞœĞĞ¤Ğ˜Ğ¯ â€” ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600;800;900&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #070810;
  --bg-dark: #0d0f1a;
  --bg-card: #111420;
  --bg-card2: #161925;
  --bg-hover: #1c2035;
  --accent-red: #e8274b;
  --accent-red-dim: rgba(232,39,75,0.15);
  --accent-gold: #f0a500;
  --accent-gold-dim: rgba(240,165,0,0.12);
  --accent-blue: #3d7fff;
  --accent-blue-dim: rgba(61,127,255,0.12);
  --accent-green: #2ecc71;
  --accent-green-dim: rgba(46,204,113,0.12);
  --accent-purple: #9b59b6;
  --text-primary: #e8e9f3;
  --text-secondary: #8890b0;
  --text-muted: #454d6a;
  --border: rgba(255,255,255,0.06);
  --border-bright: rgba(255,255,255,0.12);
  --shadow: 0 8px 32px rgba(0,0,0,0.6);
  --shadow-red: 0 0 30px rgba(232,39,75,0.3);
  --shadow-gold: 0 0 30px rgba(240,165,0,0.25);
  --font-display: 'Unbounded', sans-serif;
  --font-body: 'Manrope', sans-serif;
  --phase-color: var(--accent-gold);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg-deep);color:var(--text-primary);font-family:var(--font-body);}
::selection{background:var(--accent-red-dim);color:var(--accent-red);}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.5s,transform 0.5s;z-index:10;}
.screen.hidden{opacity:0;pointer-events:none;transform:scale(0.97);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NOISE OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANIMATED BG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-orbs{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:0;}
.orb{position:absolute;border-radius:50%;filter:blur(80px);animation:orbFloat 20s ease-in-out infinite;}
.orb1{width:600px;height:600px;background:radial-gradient(circle,rgba(232,39,75,0.06),transparent 70%);top:-200px;left:-100px;animation-delay:0s;}
.orb2{width:500px;height:500px;background:radial-gradient(circle,rgba(61,127,255,0.05),transparent 70%);bottom:-150px;right:-100px;animation-delay:-7s;}
.orb3{width:400px;height:400px;background:radial-gradient(circle,rgba(240,165,0,0.04),transparent 70%);top:40%;left:40%;animation-delay:-14s;}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(40px,-60px) scale(1.1);}66%{transform:translate(-30px,40px) scale(0.95);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-loading{background:var(--bg-deep);z-index:100;}
.load-logo{font-family:var(--font-display);font-size:3rem;font-weight:900;letter-spacing:0.3em;color:var(--accent-red);text-shadow:0 0 60px rgba(232,39,75,0.5);animation:logoPulse 2s ease-in-out infinite;}
.load-sub{font-size:0.75rem;letter-spacing:0.5em;color:var(--text-muted);margin-top:12px;text-transform:uppercase;}
.load-bar{width:200px;height:2px;background:var(--bg-card2);margin-top:40px;border-radius:1px;overflow:hidden;}
.load-bar-fill{height:100%;background:var(--accent-red);border-radius:1px;animation:loadFill 2.5s ease-in-out forwards;}
@keyframes loadFill{0%{width:0%;}100%{width:100%;}}
@keyframes logoPulse{0%,100%{text-shadow:0 0 60px rgba(232,39,75,0.5);}50%{text-shadow:0 0 100px rgba(232,39,75,0.8),0 0 30px rgba(232,39,75,0.4);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-menu{background:var(--bg-deep);}
.menu-wrap{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:0;}
.menu-title{font-family:var(--font-display);font-size:clamp(2.5rem,7vw,5rem);font-weight:900;letter-spacing:0.2em;background:linear-gradient(135deg,#e8274b,#f0a500,#e8274b);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:titleShimmer 4s linear infinite;}
@keyframes titleShimmer{0%{background-position:0%}100%{background-position:200%}}
.menu-subtitle{font-size:0.7rem;letter-spacing:0.6em;color:var(--text-muted);margin-bottom:60px;text-transform:uppercase;}
.menu-buttons{display:flex;flex-direction:column;gap:12px;width:280px;}
.btn-menu{background:transparent;border:1px solid var(--border-bright);color:var(--text-primary);font-family:var(--font-display);font-size:0.65rem;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;padding:16px 24px;cursor:pointer;position:relative;overflow:hidden;transition:all 0.3s;}
.btn-menu::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--accent-red-dim),transparent);opacity:0;transition:opacity 0.3s;}
.btn-menu:hover::before{opacity:1;}
.btn-menu:hover{border-color:var(--accent-red);color:var(--accent-red);box-shadow:var(--shadow-red);}
.btn-menu.primary{border-color:var(--accent-red);background:var(--accent-red-dim);}
.btn-menu.primary:hover{background:rgba(232,39,75,0.25);}
.menu-version{position:absolute;bottom:20px;font-size:0.65rem;color:var(--text-muted);letter-spacing:0.2em;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-setup{background:var(--bg-deep);overflow-y:auto;justify-content:flex-start;padding:40px 20px;}
.setup-wrap{position:relative;z-index:1;width:100%;max-width:700px;margin:0 auto;}
.setup-title{font-family:var(--font-display);font-size:1.4rem;font-weight:800;letter-spacing:0.1em;color:var(--accent-red);margin-bottom:8px;}
.setup-sub{font-size:0.8rem;color:var(--text-secondary);margin-bottom:36px;}
.setup-section{margin-bottom:32px;}
.setup-label{font-size:0.65rem;font-weight:700;letter-spacing:0.3em;color:var(--text-muted);text-transform:uppercase;margin-bottom:14px;}
.setup-options{display:flex;flex-wrap:wrap;gap:10px;}
.opt-btn{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:0.8rem;font-weight:500;padding:10px 18px;cursor:pointer;border-radius:4px;transition:all 0.2s;}
.opt-btn:hover{border-color:var(--border-bright);color:var(--text-primary);}
.opt-btn.active{border-color:var(--accent-red);color:var(--accent-red);background:var(--accent-red-dim);}
.mode-card{background:var(--bg-card);border:1px solid var(--border);padding:14px 16px;border-radius:6px;cursor:pointer;transition:all 0.2s;min-width:200px;flex:1;}
.mode-card:hover{border-color:var(--border-bright);}
.mode-card.active{border-color:var(--accent-gold);background:var(--accent-gold-dim);}
.mode-card-name{font-size:0.75rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;}
.mode-card-desc{font-size:0.7rem;color:var(--text-muted);}
.name-input{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);font-family:var(--font-body);font-size:0.9rem;padding:12px 16px;width:100%;border-radius:4px;outline:none;transition:border-color 0.2s;}
.name-input:focus{border-color:var(--accent-red);}
.btn-start{width:100%;background:var(--accent-red);border:none;color:white;font-family:var(--font-display);font-size:0.7rem;font-weight:700;letter-spacing:0.2em;padding:18px;cursor:pointer;text-transform:uppercase;margin-top:20px;transition:all 0.3s;border-radius:4px;}
.btn-start:hover{background:#ff1a3c;box-shadow:0 0 40px rgba(232,39,75,0.4);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-game{background:var(--bg-deep);flex-direction:row;align-items:stretch;justify-content:stretch;padding:0;}
.game-layout{display:grid;grid-template-columns:1fr 340px;grid-template-rows:auto 1fr;width:100%;height:100%;gap:0;}
.game-main{grid-column:1;grid-row:1/3;display:flex;flex-direction:column;overflow:hidden;}
.game-sidebar{grid-column:2;grid-row:1/3;display:flex;flex-direction:column;border-left:1px solid var(--border);overflow:hidden;}

/* Phase Header */
.phase-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;background:rgba(0,0,0,0.3);flex-shrink:0;}
.phase-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;background:var(--accent-red-dim);border:1px solid var(--accent-red);animation:phaseGlow 2s ease-in-out infinite;}
@keyframes phaseGlow{0%,100%{box-shadow:0 0 10px rgba(232,39,75,0.3);}50%{box-shadow:0 0 20px rgba(232,39,75,0.6);}}
.phase-icon.day{background:var(--accent-gold-dim);border-color:var(--accent-gold);animation:phaseGlowGold 2s ease-in-out infinite;}
@keyframes phaseGlowGold{0%,100%{box-shadow:0 0 10px rgba(240,165,0,0.3);}50%{box-shadow:0 0 20px rgba(240,165,0,0.6);}}
.phase-info{flex:1;}
.phase-title{font-family:var(--font-display);font-size:0.9rem;font-weight:700;letter-spacing:0.05em;}
.phase-sub{font-size:0.7rem;color:var(--text-muted);}
.phase-round{font-family:var(--font-display);font-size:0.65rem;font-weight:600;color:var(--text-muted);letter-spacing:0.2em;}
.vote-counter{font-family:var(--font-display);font-size:0.65rem;font-weight:700;color:var(--accent-gold);background:var(--accent-gold-dim);border:1px solid rgba(240,165,0,0.3);padding:4px 10px;border-radius:20px;letter-spacing:0.1em;}

/* Players Grid */
.players-area{padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;overflow-y:auto;flex-shrink:0;max-height:45vh;}
.player-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden;}
.player-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity 0.25s;}
.player-card:hover:not(.eliminated):not(.human-card) .player-card::before{opacity:1;}
.player-card.eliminated{opacity:0.35;filter:grayscale(1);}
.player-card.mafia-card{border-color:rgba(232,39,75,0.3);}
.player-card.human-card{border-color:rgba(61,127,255,0.4);background:var(--accent-blue-dim);}
.player-card.selected{border-color:var(--accent-red);box-shadow:0 0 20px rgba(232,39,75,0.3);}
.player-card.sheriff-found{border-color:var(--accent-gold);background:var(--accent-gold-dim);}
.player-card.protected{border-color:var(--accent-green);}
.pc-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin:0 auto 8px;position:relative;}
.pc-name{font-size:0.7rem;font-weight:700;text-align:center;margin-bottom:6px;}
.pc-role-badge{font-size:0.55rem;font-weight:600;letter-spacing:0.1em;text-align:center;padding:2px 6px;border-radius:3px;text-transform:uppercase;}
.pc-susp{width:100%;height:3px;background:var(--bg-dark);border-radius:2px;margin-top:8px;overflow:hidden;}
.pc-susp-fill{height:100%;border-radius:2px;transition:width 0.8s ease;}
.pc-status{position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:50%;}
.status-alive{background:var(--accent-green);box-shadow:0 0 6px rgba(46,204,113,0.6);}
.status-dead{background:var(--text-muted);}
.pc-vote-indicator{position:absolute;top:6px;left:6px;font-size:0.6rem;background:var(--accent-red);color:white;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;display:none;}
.vote-on .pc-vote-indicator{display:flex;}

/* Chat */
.chat-area{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;}
.msg{display:flex;gap:10px;animation:msgIn 0.4s ease-out;}
@keyframes msgIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.msg-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.85rem;flex-shrink:0;margin-top:2px;}
.msg-body{flex:1;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:3px;}
.msg-name{font-size:0.7rem;font-weight:700;}
.msg-time{font-size:0.6rem;color:var(--text-muted);}
.msg-role-tag{font-size:0.55rem;font-weight:600;padding:1px 5px;border-radius:2px;text-transform:uppercase;letter-spacing:0.1em;}
.msg-text{font-size:0.82rem;line-height:1.5;color:var(--text-secondary);}
.msg-text.typing::after{content:'â–‹';animation:blink 0.7s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
.msg.system-msg{justify-content:center;}
.msg.system-msg .msg-body{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:6px;padding:8px 14px;text-align:center;flex:none;max-width:80%;}
.msg.system-msg .msg-text{font-size:0.75rem;color:var(--text-muted);}
.msg.phase-msg .msg-body{background:var(--accent-red-dim);border:1px solid rgba(232,39,75,0.3);}
.msg.phase-msg .msg-text{color:var(--accent-red);font-weight:600;}
.msg.day-phase-msg .msg-body{background:var(--accent-gold-dim);border:1px solid rgba(240,165,0,0.3);}
.msg.day-phase-msg .msg-text{color:var(--accent-gold);font-weight:600;}
.msg.result-msg .msg-body{background:rgba(155,89,182,0.1);border:1px solid rgba(155,89,182,0.3);}
.msg.result-msg .msg-text{color:#b57cd6;}
.msg.human-msg .msg-body{background:var(--accent-blue-dim);border-left:2px solid var(--accent-blue);}
.msg.human-msg .msg-text{color:var(--text-primary);}

/* Input */
.chat-input-area{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;}
.chat-input{flex:1;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);font-family:var(--font-body);font-size:0.85rem;padding:10px 14px;border-radius:6px;outline:none;transition:border-color 0.2s;}
.chat-input:focus{border-color:var(--accent-blue);}
.btn-send{background:var(--accent-blue);border:none;color:white;width:40px;height:40px;border-radius:6px;cursor:pointer;font-size:1rem;transition:all 0.2s;flex-shrink:0;}
.btn-send:hover{background:#2d6de8;}
.btn-mic{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);width:40px;height:40px;border-radius:6px;cursor:pointer;font-size:1rem;transition:all 0.2s;flex-shrink:0;}
.btn-mic.active{background:var(--accent-red-dim);border-color:var(--accent-red);color:var(--accent-red);}
.btn-mic:hover{border-color:var(--border-bright);color:var(--text-primary);}

/* Action Bar */
.action-bar{padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;flex-shrink:0;}
.btn-action{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:0.72rem;font-weight:600;padding:8px 14px;cursor:pointer;border-radius:4px;transition:all 0.2s;flex:1;min-width:80px;}
.btn-action:hover{border-color:var(--border-bright);color:var(--text-primary);}
.btn-action.danger{border-color:rgba(232,39,75,0.4);color:var(--accent-red);}
.btn-action.danger:hover{background:var(--accent-red-dim);}
.btn-action.safe{border-color:rgba(46,204,113,0.4);color:var(--accent-green);}
.btn-action.safe:hover{background:var(--accent-green-dim);}
.btn-action:disabled{opacity:0.3;cursor:not-allowed;}

/* Sidebar */
.sidebar-section{padding:14px 14px;border-bottom:1px solid var(--border);}
.sidebar-title{font-family:var(--font-display);font-size:0.6rem;font-weight:700;letter-spacing:0.3em;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;}
.my-role-card{background:var(--bg-card2);border-radius:8px;padding:14px;border:1px solid var(--border-bright);display:flex;align-items:center;gap:12px;}
.my-role-icon{font-size:1.8rem;}
.my-role-name{font-family:var(--font-display);font-size:0.8rem;font-weight:700;}
.my-role-desc{font-size:0.7rem;color:var(--text-muted);margin-top:2px;}
.susp-list{display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto;}
.susp-item{display:flex;align-items:center;gap:8px;}
.susp-name{font-size:0.72rem;width:70px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.susp-bar{flex:1;height:6px;background:var(--bg-dark);border-radius:3px;overflow:hidden;}
.susp-bar-fill{height:100%;border-radius:3px;transition:width 1s ease;}
.susp-pct{font-size:0.65rem;color:var(--text-muted);width:28px;text-align:right;}
.susp-bar-fill.low{background:linear-gradient(90deg,var(--accent-green),#27ae60);}
.susp-bar-fill.mid{background:linear-gradient(90deg,var(--accent-gold),#e67e22);}
.susp-bar-fill.high{background:linear-gradient(90deg,var(--accent-red),#c0392b);}
.alive-count{display:flex;gap:16px;justify-content:center;}
.count-item{text-align:center;}
.count-num{font-family:var(--font-display);font-size:1.4rem;font-weight:800;}
.count-label{font-size:0.6rem;color:var(--text-muted);letter-spacing:0.1em;}
.count-item.mafia .count-num{color:var(--accent-red);}
.count-item.civil .count-num{color:var(--accent-blue);}
.game-log{max-height:150px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;}
.log-item{font-size:0.68rem;color:var(--text-muted);padding:4px 6px;border-left:2px solid var(--border);}
.log-item.kill{border-left-color:var(--accent-red);color:rgba(232,39,75,0.8);}
.log-item.save{border-left-color:var(--accent-green);color:rgba(46,204,113,0.8);}
.log-item.check{border-left-color:var(--accent-gold);color:rgba(240,165,0,0.8);}
.log-item.vote{border-left-color:var(--accent-blue);color:rgba(61,127,255,0.8);}
.voice-toggle{display:flex;align-items:center;gap:8px;font-size:0.75rem;cursor:pointer;}
.voice-toggle input{accent-color:var(--accent-red);}
.speed-slider{width:100%;accent-color:var(--accent-red);}

/* Night overlay */
.night-overlay{position:fixed;inset:0;background:rgba(0,0,20,0.85);z-index:50;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.8s;}
.night-overlay.active{opacity:1;pointer-events:all;}
.night-title{font-family:var(--font-display);font-size:2rem;font-weight:900;color:var(--text-muted);letter-spacing:0.3em;margin-bottom:8px;}
.night-sub{font-size:0.8rem;color:var(--text-muted);letter-spacing:0.2em;margin-bottom:40px;}
.night-action-wrap{background:var(--bg-card);border:1px solid var(--border-bright);border-radius:12px;padding:24px;min-width:320px;max-width:480px;}
.night-action-title{font-size:0.65rem;font-weight:700;letter-spacing:0.3em;color:var(--text-muted);text-transform:uppercase;margin-bottom:16px;}
.night-targets{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;}
.night-target-btn{background:var(--bg-dark);border:1px solid var(--border);color:var(--text-primary);font-family:var(--font-body);font-size:0.85rem;padding:12px 16px;cursor:pointer;border-radius:6px;text-align:left;transition:all 0.2s;display:flex;align-items:center;gap:10px;}
.night-target-btn:hover{border-color:var(--accent-red);background:var(--accent-red-dim);color:var(--accent-red);}
.night-target-btn.doctor-btn:hover{border-color:var(--accent-green);background:var(--accent-green-dim);color:var(--accent-green);}
.night-skip-btn{margin-top:12px;background:transparent;border:1px solid var(--text-muted);color:var(--text-muted);font-family:var(--font-body);font-size:0.75rem;padding:10px;cursor:pointer;border-radius:6px;width:100%;transition:all 0.2s;}
.night-skip-btn:hover{border-color:var(--text-secondary);color:var(--text-secondary);}
.night-result{background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:16px;font-size:0.82rem;color:var(--text-secondary);line-height:1.6;display:none;}
.night-result.show{display:block;}
.night-result .found-mafia{color:var(--accent-red);font-weight:700;}
.night-result .found-civil{color:var(--accent-green);font-weight:700;}
.btn-continue{width:100%;background:var(--accent-red);border:none;color:white;font-family:var(--font-display);font-size:0.65rem;font-weight:700;letter-spacing:0.2em;padding:14px;cursor:pointer;border-radius:6px;margin-top:16px;display:none;}
.btn-continue.show{display:block;}
.btn-continue:hover{background:#ff1a3c;}

/* End screen */
#screen-end{background:var(--bg-deep);z-index:20;}
.end-wrap{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:20px;max-width:500px;width:100%;padding:20px;}
.end-title{font-family:var(--font-display);font-size:2.5rem;font-weight:900;text-align:center;}
.end-title.win{color:var(--accent-green);text-shadow:0 0 40px rgba(46,204,113,0.4);}
.end-title.lose{color:var(--accent-red);text-shadow:0 0 40px rgba(232,39,75,0.4);}
.end-subtitle{font-size:0.9rem;color:var(--text-secondary);text-align:center;}
.end-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;}
.end-stat{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center;}
.end-stat-val{font-family:var(--font-display);font-size:1.5rem;font-weight:800;color:var(--accent-gold);}
.end-stat-label{font-size:0.65rem;color:var(--text-muted);margin-top:4px;}
.end-reveal{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:16px;width:100%;}
.end-reveal-title{font-size:0.65rem;font-weight:700;letter-spacing:0.2em;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;}
.reveal-list{display:flex;flex-direction:column;gap:6px;}
.reveal-item{display:flex;align-items:center;gap:10px;font-size:0.8rem;}
.reveal-item-role{font-size:0.65rem;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase;}
.btn-menu-ret{background:transparent;border:1px solid var(--border-bright);color:var(--text-primary);font-family:var(--font-display);font-size:0.65rem;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;padding:14px 32px;cursor:pointer;transition:all 0.2s;border-radius:4px;}
.btn-menu-ret:hover{border-color:var(--accent-red);color:var(--accent-red);}

/* Vote overlay */
.vote-overlay{position:fixed;bottom:0;left:0;right:0;background:var(--bg-dark);border-top:1px solid var(--border);padding:14px 20px;z-index:40;transform:translateY(100%);transition:transform 0.4s ease;}
.vote-overlay.active{transform:translateY(0);}
.vote-overlay-title{font-size:0.65rem;font-weight:700;letter-spacing:0.3em;color:var(--accent-red);text-transform:uppercase;margin-bottom:12px;}
.vote-candidates{display:flex;flex-wrap:wrap;gap:8px;}
.vote-btn{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);font-family:var(--font-body);font-size:0.8rem;padding:8px 16px;cursor:pointer;border-radius:4px;transition:all 0.2s;}
.vote-btn:hover{border-color:var(--accent-red);background:var(--accent-red-dim);color:var(--accent-red);}
.vote-btn.voted{border-color:var(--accent-red);background:var(--accent-red);color:white;}
.vote-skip-btn{background:transparent;border:1px solid var(--text-muted);color:var(--text-muted);font-family:var(--font-body);font-size:0.75rem;padding:8px 16px;cursor:pointer;border-radius:4px;transition:all 0.2s;}
.vote-skip-btn:hover{border-color:var(--text-secondary);color:var(--text-secondary);}

/* Toast */
.toast-container{position:fixed;top:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:8px;}
.toast{background:var(--bg-card2);border:1px solid var(--border-bright);padding:10px 16px;border-radius:6px;font-size:0.78rem;color:var(--text-primary);animation:toastIn 0.3s ease,toastOut 0.3s ease 2.7s forwards;max-width:280px;box-shadow:var(--shadow);}
.toast.error{border-color:var(--accent-red);background:var(--accent-red-dim);}
.toast.success{border-color:var(--accent-green);background:var(--accent-green-dim);}
@keyframes toastIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
@keyframes toastOut{from{opacity:1;}to{opacity:0;}}

/* Day/Night transition flash */
.phase-flash{position:fixed;inset:0;z-index:60;pointer-events:none;opacity:0;}
.phase-flash.night{background:radial-gradient(circle,rgba(0,0,40,0.9),transparent);}
.phase-flash.day{background:radial-gradient(circle,rgba(240,165,0,0.15),transparent);}
.phase-flash.anim{animation:flashAnim 1.5s ease-out forwards;}
@keyframes flashAnim{0%{opacity:0;}30%{opacity:1;}100%{opacity:0;}}

/* Responsive */
@media(max-width:768px){
  .game-layout{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;}
  .game-sidebar{grid-column:1;grid-row:3;border-left:none;border-top:1px solid var(--border);max-height:200px;}
  .players-area{max-height:35vh;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));}
  .menu-title{font-size:2.5rem;}
}

/* Personality tag */
.personality-tag{font-size:0.55rem;color:var(--text-muted);margin-top:3px;text-align:center;letter-spacing:0.05em;}

/* Thinking animation */
.thinking-dots span{display:inline-block;animation:dotBounce 1.2s ease-in-out infinite;}
.thinking-dots span:nth-child(2){animation-delay:0.2s;}
.thinking-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes dotBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-4px);}}

/* Mode badge */
.mode-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.6rem;font-weight:700;letter-spacing:0.1em;padding:3px 8px;border-radius:20px;text-transform:uppercase;}
.mode-badge.paranoia{background:rgba(155,89,182,0.15);border:1px solid rgba(155,89,182,0.4);color:#b57cd6;}
.mode-badge.manipulators{background:rgba(232,39,75,0.1);border:1px solid rgba(232,39,75,0.3);color:var(--accent-red);}
.mode-badge.hardcore{background:rgba(61,127,255,0.1);border:1px solid rgba(61,127,255,0.3);color:var(--accent-blue);}
.mode-badge.chaos{background:rgba(240,165,0,0.1);border:1px solid rgba(240,165,0,0.3);color:var(--accent-gold);}
.mode-badge.theater{background:rgba(46,204,113,0.1);border:1px solid rgba(46,204,113,0.3);color:var(--accent-green);}
.mode-badge.psychology{background:rgba(255,100,150,0.1);border:1px solid rgba(255,100,150,0.3);color:#ff8cb0;}

.game-mode-display{margin-left:auto;display:flex;gap:6px;align-items:center;}
</style>
</head>
<body>
<div class="bg-orbs"><div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div></div>
<div class="toast-container" id="toastContainer"></div>
<div class="phase-flash" id="phaseFlash"></div>

<!-- LOADING -->
<div class="screen" id="screen-loading">
  <div class="load-logo">ĞœĞĞ¤Ğ˜Ğ¯</div>
  <div class="load-sub">Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ</div>
  <div class="load-bar"><div class="load-bar-fill"></div></div>
</div>

<!-- MENU -->
<div class="screen hidden" id="screen-menu">
  <div class="menu-wrap">
    <div class="menu-title">ĞœĞĞ¤Ğ˜Ğ¯</div>
    <div class="menu-subtitle">Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Â· v2.0</div>
    <div class="menu-buttons">
      <button class="btn-menu primary" onclick="showScreen('setup')">â–¶ ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°</button>
      <button class="btn-menu" onclick="showHowTo()">ğŸ“– ĞšĞ°Ğº Ğ¸Ğ³Ñ€Ğ°Ñ‚ÑŒ</button>
      <button class="btn-menu" onclick="showStats()">ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</button>
    </div>
  </div>
  <div class="menu-version">Â© ĞœĞĞ¤Ğ˜Ğ¯ 2024 Â· ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾</div>
</div>

<!-- SETUP -->
<div class="screen hidden" id="screen-setup">
  <div class="setup-wrap">
    <div class="setup-title">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸Ğ³Ñ€Ñ‹</div>
    <div class="setup-sub">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼</div>

    <div class="setup-section">
      <div class="setup-label">Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ</div>
      <input class="name-input" type="text" id="playerName" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ..." maxlength="20" value="Ğ˜Ğ³Ñ€Ğ¾Ğº">
    </div>

    <div class="setup-section">
      <div class="setup-label">ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²</div>
      <div class="setup-options" id="playerCountOpts">
        <button class="opt-btn" data-val="6" onclick="setOpt('playerCount',6,this)">6</button>
        <button class="opt-btn active" data-val="8" onclick="setOpt('playerCount',8,this)">8</button>
        <button class="opt-btn" data-val="10" onclick="setOpt('playerCount',10,this)">10</button>
      </div>
    </div>

    <div class="setup-section">
      <div class="setup-label">Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¸Ğ³Ñ€Ñ‹</div>
      <div class="setup-options" style="flex-direction:column;">
        <div class="mode-card active" data-mode="normal" onclick="setMode('normal',this)">
          <div class="mode-card-name">ĞšĞ»Ğ°ÑÑĞ¸ĞºĞ°</div>
          <div class="mode-card-desc">Ğ¡Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ° ÑĞ¾ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°Ğ¼Ğ¸</div>
        </div>
        <div class="mode-card" data-mode="paranoia" onclick="setMode('paranoia',this)">
          <div class="mode-card-name">ğŸŒ‘ ĞŸĞ°Ñ€Ğ°Ğ½Ğ¾Ğ¹Ñ</div>
          <div class="mode-card-desc">Ğ’ÑĞµ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ²Ğ°ÑÑ‚ Ğ²ÑĞµÑ… â€” ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ğ¹ Ğ·Ğ°Ğ²Ñ‹ÑˆĞµĞ½</div>
        </div>
        <div class="mode-card" data-mode="manipulators" onclick="setMode('manipulators',this)">
          <div class="mode-card-name">ğŸ­ ĞœĞ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ‚Ğ¾Ñ€Ñ‹</div>
          <div class="mode-card-desc">Ğ‘Ğ¾Ñ‚Ñ‹ Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¼ Ğ±Ğ»ĞµÑ„Ğ¾Ğ¼ â€” Ñ‚Ñ€ÑƒĞ´Ğ½ĞµĞµ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ¶ÑŒ</div>
        </div>
        <div class="mode-card" data-mode="hardcore" onclick="setMode('hardcore',this)">
          <div class="mode-card-name">ğŸ§  Ğ¥Ğ°Ñ€Ğ´ĞºĞ¾Ñ€ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°</div>
          <div class="mode-card-desc">Ğ›Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ±Ğ¾Ñ‚Ñ‹ â€” Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ Ğ²Ğ·Ğ²ĞµÑˆĞµĞ½Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ</div>
        </div>
        <div class="mode-card" data-mode="chaos" onclick="setMode('chaos',this)">
          <div class="mode-card-name">âš¡ Ğ¥Ğ°Ğ¾Ñ</div>
          <div class="mode-card-desc">Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ Ğ²ÑĞ¿Ğ»ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ğ¹ â€” Ğ½ĞµĞ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾</div>
        </div>
        <div class="mode-card" data-mode="theater" onclick="setMode('theater',this)">
          <div class="mode-card-name">ğŸª Ğ¢ĞµĞ°Ñ‚Ñ€</div>
          <div class="mode-card-desc">Ğ‘Ğ¾Ñ‚Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€ÑÑ‚ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ â€” Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞ°Ñ‚Ñ€</div>
        </div>
        <div class="mode-card" data-mode="psychology" onclick="setMode('psychology',this)">
          <div class="mode-card-name">ğŸ”¬ ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ</div>
          <div class="mode-card-desc">Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½ ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ñ</div>
        </div>
      </div>
    </div>

    <div class="setup-section">
      <div class="setup-label">Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº</div>
      <div class="setup-options">
        <button class="opt-btn active" data-val="1" onclick="setOpt('voiceEnabled',1,this)">ğŸ”Š Ğ’ĞºĞ»ÑÑ‡Ñ‘Ğ½</button>
        <button class="opt-btn" data-val="0" onclick="setOpt('voiceEnabled',0,this)">ğŸ”‡ Ğ’Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½</button>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:10px;">
      <button class="btn-menu" style="flex:1;padding:14px;" onclick="showScreen('menu')">â† ĞĞ°Ğ·Ğ°Ğ´</button>
      <button class="btn-start" style="flex:2;margin-top:0;" onclick="startGame()">ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ â†’</button>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div class="screen hidden" id="screen-game">
  <div class="game-layout">
    <!-- Main area -->
    <div class="game-main">
      <!-- Phase header -->
      <div class="phase-header">
        <div class="phase-icon" id="phaseIcon">ğŸŒ™</div>
        <div class="phase-info">
          <div class="phase-title" id="phaseTitle">ĞĞ¾Ñ‡ÑŒ 1</div>
          <div class="phase-sub" id="phaseSub">ĞœĞ°Ñ„Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ...</div>
        </div>
        <div class="phase-round" id="roundLabel">Ğ ĞĞ£ĞĞ” 1</div>
        <div class="game-mode-display" id="gameModeDisplay"></div>
      </div>
      <!-- Players grid -->
      <div class="players-area" id="playersArea"></div>
      <!-- Chat -->
      <div class="chat-area" id="chatArea"></div>
      <!-- Action bar -->
      <div class="action-bar" id="actionBar" style="display:none;">
        <button class="btn-action danger" id="btnAccuse" onclick="triggerAccuse()">âš  ĞĞ±Ğ²Ğ¸Ğ½Ğ¸Ñ‚ÑŒ</button>
        <button class="btn-action safe" id="btnDefend" onclick="triggerDefend()">ğŸ›¡ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ¸Ñ‚ÑŒÑÑ</button>
        <button class="btn-action" id="btnClaim" onclick="triggerClaim()">ğŸ­ ĞĞ°Ğ·Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ</button>
      </div>
      <!-- Input -->
      <div class="chat-input-area">
        <button class="btn-mic" id="btnMic" onclick="toggleMic()" title="Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´">ğŸ¤</button>
        <input class="chat-input" type="text" id="chatInput" placeholder="Ğ’Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." maxlength="200" onkeydown="if(event.key==='Enter')sendMessage()">
        <button class="btn-send" onclick="sendMessage()">â¤</button>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="game-sidebar">
      <!-- My role -->
      <div class="sidebar-section">
        <div class="sidebar-title">Ğ’Ğ°ÑˆĞ° Ñ€Ğ¾Ğ»ÑŒ</div>
        <div class="my-role-card" id="myRoleCard">
          <div class="my-role-icon" id="myRoleIcon">â“</div>
          <div>
            <div class="my-role-name" id="myRoleName">ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾</div>
            <div class="my-role-desc" id="myRoleDesc">Ğ Ğ¾Ğ»ÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ğ°</div>
          </div>
        </div>
      </div>

      <!-- Alive count -->
      <div class="sidebar-section">
        <div class="sidebar-title">Ğ–Ğ¸Ğ²Ñ‹Ğµ</div>
        <div class="alive-count">
          <div class="count-item civil"><div class="count-num" id="countCivil">0</div><div class="count-label">ĞœĞ¸Ñ€Ğ½Ñ‹Ğµ</div></div>
          <div class="count-item"><div class="count-num" id="countAlive">0</div><div class="count-label">Ğ’ÑĞµĞ³Ğ¾</div></div>
          <div class="count-item mafia"><div class="count-num" id="countMafia">?</div><div class="count-label">ĞœĞ°Ñ„Ğ¸Ñ</div></div>
        </div>
      </div>

      <!-- Suspicion -->
      <div class="sidebar-section" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
        <div class="sidebar-title">Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ğ¹</div>
        <div class="susp-list" id="suspList"></div>
      </div>

      <!-- Game log -->
      <div class="sidebar-section">
        <div class="sidebar-title">Ğ–ÑƒÑ€Ğ½Ğ°Ğ» ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹</div>
        <div class="game-log" id="gameLog"></div>
      </div>

      <!-- Voice settings -->
      <div class="sidebar-section">
        <div class="sidebar-title">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ°</div>
        <label class="voice-toggle">
          <input type="checkbox" id="voiceCheck" onchange="toggleVoice()" checked>
          <span>Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ²</span>
        </label>
        <div style="margin-top:8px;font-size:0.65rem;color:var(--text-muted);margin-bottom:6px;">Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ñ€ĞµÑ‡Ğ¸</div>
        <input type="range" class="speed-slider" min="0.5" max="1.8" step="0.1" value="1" id="speedSlider" oninput="updateSpeechRate(this.value)">
      </div>
    </div>
  </div>
</div>

<!-- END SCREEN -->
<div class="screen hidden" id="screen-end">
  <div class="end-wrap">
    <div class="end-title" id="endTitle">Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°</div>
    <div class="end-subtitle" id="endSubtitle"></div>
    <div class="end-stats-grid" id="endStats"></div>
    <div class="end-reveal">
      <div class="end-reveal-title">Ğ Ğ°ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ€Ğ¾Ğ»ĞµĞ¹</div>
      <div class="reveal-list" id="revealList"></div>
    </div>
    <button class="btn-menu-ret" onclick="showScreen('menu')">â† Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ</button>
  </div>
</div>

<!-- NIGHT OVERLAY -->
<div class="night-overlay" id="nightOverlay">
  <div class="night-title" id="nightTitle">ğŸŒ™ ĞĞĞ§Ğ¬</div>
  <div class="night-sub" id="nightSub">Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°ĞµÑ‚...</div>
  <div class="night-action-wrap" id="nightActionWrap">
    <div class="night-action-title" id="nightActionTitle">Ğ’Ğ«Ğ‘Ğ•Ğ Ğ˜Ğ¢Ğ• Ğ¦Ğ•Ğ›Ğ¬</div>
    <div class="night-targets" id="nightTargets"></div>
    <div class="night-result" id="nightResult"></div>
    <button class="btn-continue" id="btnContinue" onclick="continueFromNight()">ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ â†’</button>
  </div>
</div>

<!-- VOTE OVERLAY -->
<div class="vote-overlay" id="voteOverlay">
  <div class="vote-overlay-title">ğŸ—³ Ğ“ĞĞ›ĞĞ¡ĞĞ’ĞĞĞ˜Ğ• â€” ĞšĞ¾Ğ³Ğ¾ Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ?</div>
  <div class="vote-candidates" id="voteCandidates"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ROLES = { CIVILIAN:'civilian', MAFIA:'mafia', SHERIFF:'sheriff', DOCTOR:'doctor' };
const PHASES = { SETUP:'setup', NIGHT:'night', DAY:'day', VOTE:'vote', END:'end' };
const BOT_NAMES = ['ĞĞ»ĞµĞºÑĞ°Ğ½Ğ´Ñ€','Ğ”Ğ¼Ğ¸Ñ‚Ñ€Ğ¸Ğ¹','Ğ•Ğ»ĞµĞ½Ğ°','ĞĞ°Ñ‚Ğ°Ğ»ÑŒÑ','Ğ¡ĞµÑ€Ğ³ĞµĞ¹','ĞĞ»ÑŒĞ³Ğ°','ĞœĞ¸Ñ…Ğ°Ğ¸Ğ»','Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ°','ĞĞ½Ğ´Ñ€ĞµĞ¹','ĞĞ½Ğ½Ğ°'];
const BOT_AVATARS = ['ğŸ§‘','ğŸ‘¨','ğŸ‘©','ğŸ‘¦','ğŸ‘§','ğŸ§”','ğŸ‘±','ğŸ™','ğŸ§‘â€ğŸ’¼','ğŸ‘©â€ğŸ’¼'];
const ROLE_CONFIG = {
  6:  { mafia:2, sheriff:1, doctor:1, civilian:2 },
  8:  { mafia:2, sheriff:1, doctor:1, civilian:4 },
  10: { mafia:3, sheriff:1, doctor:1, civilian:5 }
};
const ROLE_DISPLAY = {
  [ROLES.CIVILIAN]: { name:'ĞœĞ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ', icon:'ğŸ‘¤', color:'#3d7fff', desc:'Ğ’Ñ‹ÑĞ²Ğ»ÑĞ¹ Ğ¼Ğ°Ñ„Ğ¸Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼' },
  [ROLES.MAFIA]:    { name:'ĞœĞ°Ñ„Ğ¸Ñ',          icon:'ğŸ”«', color:'#e8274b', desc:'Ğ£Ğ½Ğ¸Ñ‡Ñ‚Ğ¾Ğ¶Ğ°Ğ¹ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ñ… Ğ½Ğ¾Ñ‡ÑŒÑ' },
  [ROLES.SHERIFF]:  { name:'ĞšĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€',        icon:'ğŸ”', color:'#f0a500', desc:'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞ¹ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ¾Ñ‡ÑŒÑ' },
  [ROLES.DOCTOR]:   { name:'Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€',          icon:'ğŸ’‰', color:'#2ecc71', desc:'Ğ—Ğ°Ñ‰Ğ¸Ñ‰Ğ°Ğ¹ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ¾Ñ‡ÑŒÑ' }
};
const PERSONALITY_TYPES = ['ĞĞ³Ñ€ĞµÑÑĞ¾Ñ€','ĞœĞ¾Ğ»Ñ‡ÑƒĞ½','ĞœĞ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ‚Ğ¾Ñ€','ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº','ĞŸĞ°Ğ½Ğ¸ĞºÑ‘Ñ€','Ğ›Ğ¸Ğ´ĞµÑ€','ĞŸÑ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ‚Ğ¾Ñ€','ĞĞ°Ğ±Ğ»ÑĞ´Ğ°Ñ‚ĞµĞ»ÑŒ'];
const PERSONALITY_LABELS = {
  'ĞĞ³Ñ€ĞµÑÑĞ¾Ñ€':'ğŸ”¥ ĞĞ³Ñ€ĞµÑÑĞ¾Ñ€','ĞœĞ¾Ğ»Ñ‡ÑƒĞ½':'ğŸ¤ ĞœĞ¾Ğ»Ñ‡ÑƒĞ½','ĞœĞ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ‚Ğ¾Ñ€':'ğŸ•¸ ĞœĞ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ‚Ğ¾Ñ€',
  'ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº':'ğŸ§  ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº','ĞŸĞ°Ğ½Ğ¸ĞºÑ‘Ñ€':'ğŸ˜° ĞŸĞ°Ğ½Ğ¸ĞºÑ‘Ñ€','Ğ›Ğ¸Ğ´ĞµÑ€':'ğŸ‘‘ Ğ›Ğ¸Ğ´ĞµÑ€',
  'ĞŸÑ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ‚Ğ¾Ñ€':'ğŸ˜ˆ ĞŸÑ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ‚Ğ¾Ñ€','ĞĞ°Ğ±Ğ»ÑĞ´Ğ°Ñ‚ĞµĞ»ÑŒ':'ğŸ‘ ĞĞ°Ğ±Ğ»ÑĞ´Ğ°Ñ‚ĞµĞ»ÑŒ'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = {
  players: [],
  humanIdx: 0,
  phase: PHASES.SETUP,
  round: 1,
  mode: 'normal',
  voiceEnabled: true,
  speechRate: 1.0,
  nightKillTarget: null,
  nightSaveTarget: null,
  nightCheckTarget: null,
  votes: {},
  pendingBotMessages: [],
  processingNight: false,
  gameStartTime: 0,
  totalEliminations: 0,
  correctAccusations: 0,
  sheriffChecks: [],
  gameLog: [],
  settings: { playerCount: 8 }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOT AI â€” PSYCHOLOGICAL PROFILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createBotProfile(personality, mode) {
  const base = {
    'ĞĞ³Ñ€ĞµÑÑĞ¾Ñ€':    { confidence:0.8, aggression:0.9, manipulation:0.4, riskTolerance:0.8, emotionalVolatility:0.7, bluffProb:0.3, verbosity:0.8 },
    'ĞœĞ¾Ğ»Ñ‡ÑƒĞ½':      { confidence:0.5, aggression:0.2, manipulation:0.5, riskTolerance:0.3, emotionalVolatility:0.2, bluffProb:0.4, verbosity:0.2 },
    'ĞœĞ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ‚Ğ¾Ñ€': { confidence:0.7, aggression:0.5, manipulation:0.95, riskTolerance:0.6, emotionalVolatility:0.3, bluffProb:0.9, verbosity:0.6 },
    'ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº':    { confidence:0.9, aggression:0.3, manipulation:0.3, riskTolerance:0.4, emotionalVolatility:0.1, bluffProb:0.2, verbosity:0.5 },
    'ĞŸĞ°Ğ½Ğ¸ĞºÑ‘Ñ€':     { confidence:0.3, aggression:0.5, manipulation:0.2, riskTolerance:0.2, emotionalVolatility:0.95, bluffProb:0.3, verbosity:0.7 },
    'Ğ›Ğ¸Ğ´ĞµÑ€':       { confidence:0.95, aggression:0.6, manipulation:0.6, riskTolerance:0.5, emotionalVolatility:0.3, bluffProb:0.5, verbosity:0.9 },
    'ĞŸÑ€Ğ¾Ğ²Ğ¾ĞºĞ°Ñ‚Ğ¾Ñ€':  { confidence:0.6, aggression:0.7, manipulation:0.8, riskTolerance:0.7, emotionalVolatility:0.6, bluffProb:0.7, verbosity:0.75 },
    'ĞĞ°Ğ±Ğ»ÑĞ´Ğ°Ñ‚ĞµĞ»ÑŒ': { confidence:0.6, aggression:0.2, manipulation:0.4, riskTolerance:0.3, emotionalVolatility:0.2, bluffProb:0.3, verbosity:0.3 }
  }[personality];
  // Mode modifiers
  if(mode === 'paranoia') { base.emotionalVolatility += 0.2; base.aggression += 0.15; }
  if(mode === 'manipulators') { base.bluffProb += 0.25; base.manipulation += 0.2; }
  if(mode === 'hardcore') { base.confidence = Math.min(1, base.confidence+0.15); base.bluffProb = Math.max(0, base.bluffProb-0.2); }
  if(mode === 'chaos') { base.emotionalVolatility += 0.3; base.riskTolerance += 0.2; }
  if(mode === 'theater') { base.verbosity = Math.min(1, base.verbosity+0.3); base.emotionalVolatility += 0.15; }
  if(mode === 'psychology') { base.emotionalVolatility += 0.25; }
  Object.keys(base).forEach(k => base[k] = Math.min(1, Math.max(0, base[k] + (Math.random()-0.5)*0.15)));
  return base;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOT MEMORY SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMemory() { return { accusations:{}, defenses:{}, votedFor:[], roleClaims:{}, contradictions:[], suspicionOf:{}, lastSpeech:0 }; }

function recordAccusation(byIdx, targetIdx) {
  const mem = G.players[byIdx].memory;
  if(!mem.accusations[targetIdx]) mem.accusations[targetIdx] = 0;
  mem.accusations[targetIdx]++;
  // If mafia accuses civilian â†’ update mafia player's suspicion
  updateSuspicion(byIdx, 0.03, 'accuser_pattern');
}

function recordDefense(byIdx) {
  const mem = G.players[byIdx].memory;
  mem.defenses.count = (mem.defenses.count||0)+1;
  if(mem.defenses.count > 3) { updateSuspicion(byIdx, 0.08, 'over_defense'); }
}

function recordVote(voterIdx, targetIdx) {
  G.players[voterIdx].memory.votedFor.push({ target:targetIdx, round:G.round });
}

function checkContradictions(playerIdx, msg) {
  const p = G.players[playerIdx];
  const m = msg.toLowerCase();
  let suspicious = false;
  // Contradiction: claimed role but acting differently
  if(p.memory.roleClaims.claimed === ROLES.SHERIFF && G.players[playerIdx].role !== ROLES.SHERIFF) suspicious = true;
  if(p.memory.roleClaims.claimed === ROLES.DOCTOR && G.players[playerIdx].role !== ROLES.DOCTOR) suspicious = true;
  if(suspicious) { updateSuspicion(playerIdx, 0.12, 'contradiction'); p.memory.contradictions.push(G.round); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUSPICION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSuspicion(idx, delta, reason) {
  if(!G.players[idx] || G.players[idx].eliminated) return;
  const old = G.players[idx].suspicion;
  let newVal = Math.max(0, Math.min(1, old + delta));
  // Mode amplifiers
  if(G.mode === 'paranoia') newVal = Math.min(1, newVal + 0.03);
  if(G.mode === 'chaos' && Math.random() < 0.15) newVal = Math.min(1, newVal + (Math.random()*0.2));
  G.players[idx].suspicion = newVal;
  renderSuspicion();
}

function updateAllSuspicions() {
  G.players.forEach((p,i) => {
    if(p.eliminated || i === G.humanIdx) return;
    // Random drift
    if(G.mode === 'paranoia') updateSuspicion(i, (Math.random()-0.4)*0.04, 'drift');
    else updateSuspicion(i, (Math.random()-0.5)*0.02, 'drift');
    // Volatility jitter
    if(p.profile && Math.random() < p.profile.emotionalVolatility*0.1) updateSuspicion(i, (Math.random()-0.5)*0.06, 'volatile');
  });
}

function recalcBotSuspicion(botIdx) {
  // How suspicious is this bot of others
  const bot = G.players[botIdx];
  if(!bot.botSuspicion) bot.botSuspicion = {};
  G.players.forEach((p,i) => {
    if(i === botIdx || p.eliminated) return;
    let s = bot.botSuspicion[i] || 0.3;
    // Mafia bots know their partners
    if(bot.role === ROLES.MAFIA && p.role === ROLES.MAFIA) s = -1; // trusted
    // Sheriff knows checked players
    if(bot.role === ROLES.SHERIFF && G.sheriffChecks.some(c => c.target===i)) {
      const check = G.sheriffChecks.find(c => c.target===i);
      s = check.isMafia ? 0.95 : 0.05;
    }
    // Pattern: heavily accused players are more suspicious
    s += (p.suspicion - 0.3) * 0.3;
    // Human as wildcard
    if(i === G.humanIdx) s += (Math.random()-0.4)*0.1;
    bot.botSuspicion[i] = Math.max(0, Math.min(0.99, s));
  });
}

function getMostSuspectFor(botIdx) {
  const bot = G.players[botIdx];
  recalcBotSuspicion(botIdx);
  let best = -1, bestS = -1;
  G.players.forEach((p,i) => {
    if(i === botIdx || p.eliminated) return;
    if(bot.role === ROLES.MAFIA && p.role === ROLES.MAFIA) return;
    const s = (bot.botSuspicion||{})[i] || p.suspicion;
    if(s > bestS) { bestS = s; best = i; }
  });
  return best;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONVERSATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMOTION_KEYWORDS = {
  accusation: ['Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ²Ğ°Ñ','ÑÑ‚Ñ€Ğ°Ğ½Ğ½Ğ¾','Ğ¼Ğ°Ñ„Ğ¸Ñ','Ğ»Ğ¶Ñ‘Ñ‚','Ğ²Ñ€Ñ‘Ñ‚','ÑĞ»ĞµĞ´Ğ¸','Ğ¾Ğ±Ğ²Ğ¸Ğ½ÑÑ','ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸','Ğ½Ğ°Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚','Ğ¼Ğ¾Ğ»Ñ‡Ğ¸Ñ‚','Ğ¿Ñ€ÑÑ‡ĞµÑ‚ÑÑ','ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚','ÑĞ²Ğ½Ğ¾','100%'],
  defense:     ['Ğ½ĞµĞ²Ğ¸Ğ½Ğ¾Ğ²ĞµĞ½','Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹','ĞºĞ»ÑĞ½ÑƒÑÑŒ','Ğ½Ğµ Ğ¼Ğ°Ñ„Ğ¸Ñ','Ñ‡ĞµÑÑ‚Ğ½Ğ¾','Ğ´Ğ¾Ğ²ĞµÑ€ÑĞ¹','Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸','Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¼ĞµĞ½Ñ','Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ','Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ¼Ğ°Ñ„Ğ¸Ğ¸'],
  roleclaim:   ['Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€','Ñ Ğ´Ğ¾ĞºÑ‚Ğ¾Ñ€','Ñ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹','Ñ ÑˆĞµÑ€Ğ¸Ñ„','Ñ Ğ²Ñ€Ğ°Ñ‡','Ğ¼Ğ¾Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ'],
  emotional:   ['Ğ±Ğ¾ÑÑÑŒ','Ğ¿Ğ°Ğ½Ğ¸ĞºĞ°','ÑƒĞ²ĞµÑ€ĞµĞ½','Ğ·Ğ»ÑÑÑŒ','Ñ€Ğ°ÑÑÑ‚Ñ€Ğ¾ĞµĞ½','ÑƒĞ´Ğ¸Ğ²Ğ»Ñ‘Ğ½','ÑÑ‚Ñ€Ğ°Ğ½Ğ½Ğ¾','Ñ‚Ğ¾Ñ‡Ğ½Ğ¾','ÑƒĞ²ĞµÑ€ĞµĞ½','Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ'],
  threats:     ['Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑÑƒĞµĞ¼','Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»Ğ¸Ğ»Ğ¸','ÑƒĞ±ĞµÑ€Ñ‘Ğ¼','Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ğ¼','Ğ²Ğ¾Ğ½'],
  logic:       ['Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾','ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ½Ğ°','Ğ¿Ñ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»','ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°','Ñ„Ğ°ĞºÑ‚Ñ‹','Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾']
};

function parsePlayerMessage(msg, senderIdx) {
  const m = msg.toLowerCase();
  const p = G.players[senderIdx];
  let suspDelta = 0;

  // Detect emotion type
  let dominant = null;
  let maxCount = 0;
  for(const [type, words] of Object.entries(EMOTION_KEYWORDS)) {
    const count = words.filter(w => m.includes(w)).length;
    if(count > maxCount) { maxCount = count; dominant = type; }
  }

  // Extract accusation target
  let accuseTarget = -1;
  G.players.forEach((op, i) => {
    if(i === senderIdx || op.eliminated) return;
    if(m.includes(op.name.toLowerCase())) {
      if(dominant === 'accusation') {
        accuseTarget = i;
        updateSuspicion(i, 0.08, 'accused');
        recordAccusation(senderIdx, i);
        if(i === G.humanIdx) updateSuspicion(senderIdx, 0.03, 'accused_human');
      }
    }
  });

  // Role claim detection
  if(dominant === 'roleclaim') {
    if(m.includes('ĞºĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€') || m.includes('ÑˆĞµÑ€Ğ¸Ñ„')) {
      p.memory.roleClaims.claimed = ROLES.SHERIFF;
      if(p.role !== ROLES.SHERIFF) { updateSuspicion(senderIdx, 0.15, 'false_role_claim'); }
      else { updateSuspicion(senderIdx, -0.1, 'true_role_claim'); }
    }
    if(m.includes('Ğ´Ğ¾ĞºÑ‚Ğ¾Ñ€') || m.includes('Ğ²Ñ€Ğ°Ñ‡')) {
      p.memory.roleClaims.claimed = ROLES.DOCTOR;
      if(p.role !== ROLES.DOCTOR) { updateSuspicion(senderIdx, 0.12, 'false_doctor_claim'); }
    }
  }

  // Over-defensive pattern
  if(dominant === 'defense') {
    recordDefense(senderIdx);
    updateSuspicion(senderIdx, -0.02, 'defense_minor');
  }

  // Mode: psychology â€” emotional tone strongly affects suspicion
  if(G.mode === 'psychology' && dominant === 'emotional') suspDelta += 0.05;

  // Contradiction check
  checkContradictions(senderIdx, msg);
  if(suspDelta !== 0) updateSuspicion(senderIdx, suspDelta, 'emotion');
  return { dominant, accuseTarget };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOT MESSAGE GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MSG_TEMPLATES = {
  accusation: [
    "{t} Ğ²ĞµĞ´Ñ‘Ñ‚ ÑĞµĞ±Ñ ĞºÑ€Ğ°Ğ¹Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾. Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ½Ğ° ĞµĞ³Ğ¾ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸.",
    "Ğ¯ ÑĞ»ĞµĞ¶Ñƒ Ğ·Ğ° {t} Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° â€” Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ÑĞ²Ğ½Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº.",
    "{t} ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ñ‚Ğ¸Ñ…Ğ¸Ğ¹. ĞœĞ°Ñ„Ğ¸Ñ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚Ğ°Ğº Ğ¸ Ğ´ĞµĞ»Ğ°ĞµÑ‚.",
    "ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: {t} Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ½Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğ¸.",
    "{t} Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ½Ğµ Ñ‚ĞµÑ… Ğ»ÑĞ´ĞµĞ¹. Ğ¯Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğº Ğ¼Ğ°Ñ„Ğ¸Ğ¸.",
    "Ğ’ÑĞµ ÑƒĞ»Ğ¸ĞºĞ¸ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ğ½Ğ° {t}. ĞÑƒĞ¶Ğ½Ğ¾ ĞµĞ³Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ.",
    "Ğ¯ Ğ½Ğµ Ğ²ĞµÑ€Ñ {t}. Ğ•Ğ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ·Ğ²ÑƒÑ‡Ğ°Ñ‚ ĞºĞ°Ğº Ğ»Ğ¾Ğ¶ÑŒ.",
    "{t} Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°Ñ‚ÑŒ ÑĞ²Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ…. ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ?",
    "Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ñƒ {t} â€” Ğ¿Ğ°Ğ½Ğ¸ĞºĞ° Ñ‚Ğ°Ğ¼, Ğ³Ğ´Ğµ ĞµÑ‘ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ.",
    "{t} ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ°Ğ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ğ¾ Ñ€ĞµĞ°Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ° Ğ¾Ğ±Ğ²Ğ¸Ğ½ĞµĞ½Ğ¸Ñ. Ğ’Ğ¸Ğ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ‚Ğ°Ğº Ğ¸ Ğ²ĞµĞ´ÑƒÑ‚ ÑĞµĞ±Ñ."
  ],
  defense_self: [
    "Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ¼Ğ½Ğµ Ğ²Ñ€Ğ°Ñ‚ÑŒ? Ğ¯ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¸ Ñ…Ğ¾Ñ‡Ñƒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¼Ğ°Ñ„Ğ¸Ñ.",
    "Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ¼Ğ¾Ğ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ° â€” Ñ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ» Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾.",
    "Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ğ¼ĞµĞ½Ñ ÑƒĞ±ĞµÑ€Ñ‘Ñ‚Ğµ â€” Ğ¼Ğ°Ñ„Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞºĞ°Ğ¶ĞµÑ‚ ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾.",
    "ĞœĞµĞ½Ñ Ğ¾Ğ±Ğ²Ğ¸Ğ½ÑÑÑ‚ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ, Ñ‡Ñ‚Ğ¾ Ñ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñƒ. Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ğ¾.",
    "Ğ¯ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ñ, Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸ â€” ĞºĞ¾Ğ¼Ñƒ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¼ĞµĞ½Ñ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ?",
    "ĞšĞ»ÑĞ½ÑƒÑÑŒ, Ñ Ğ½Ğµ Ğ¼Ğ°Ñ„Ğ¸Ñ. Ğ›ÑƒÑ‡ÑˆĞµ Ğ·Ğ°Ğ¹Ğ¼Ğ¸Ñ‚ĞµÑÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ°Ğ¼Ğ¸.",
    "Ğ’Ñ‹ Ğ°Ñ‚Ğ°ĞºÑƒĞµÑ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞºĞ°Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ÑƒÑ Ğ¼Ğ°Ñ„Ğ¸Ñ.",
    "ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ¼Ğ¾Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ â€” Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ğ» Ğ³Ğ¾Ñ€Ğ¾Ğ´Ñƒ Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°."
  ],
  agreement: [
    "Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞµĞ½ Ñ {t}. Ğ­Ñ‚Ğ¸ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ñ‹.",
    "{t} Ğ¿Ñ€Ğ°Ğ² â€” Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¸ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒÑÑ Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¸Ğ³Ñ€Ğ¾ĞºÑƒ.",
    "Ğ¯ Ñ‚Ğ¾Ğ¶Ğµ Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ» ÑÑ‚Ğ¾. ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ {t}.",
    "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğµ, {t}. Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑÑƒĞµĞ¼.",
    "Ğ¢Ğ¾Ñ‡Ğ½Ğ¾. {t} Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ñ Ñ‚Ğ¾Ğ¶Ğµ Ğ²Ğ¸Ğ¶Ñƒ."
  ],
  doubt: [
    "ĞĞµ ÑƒĞ²ĞµÑ€ĞµĞ½. Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ»Ğ¾ Ğ´Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ².",
    "ĞÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑƒĞ¼Ğ°Ñ‚ÑŒ. ĞœĞ¾Ğ¶ĞµÑ‚, ÑÑ‚Ğ¾ Ğ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‚Ñ‹Ğ²Ğ°ÑÑ‚?",
    "ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ñ‘Ğ¼. ĞĞµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ‚Ğ¾Ñ€Ğ¾Ğ¿Ğ¸Ñ‚ÑŒÑÑ Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.",
    "Ğ­Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ»Ğ¾Ğ²ÑƒÑˆĞºĞ° Ğ¼Ğ°Ñ„Ğ¸Ğ¸ â€” ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ñ€Ğ½Ğ¾Ğ³Ğ¾.",
    "Ğ¯ Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ĞµĞ· Ğ²ĞµÑĞ¾Ğ¼Ñ‹Ñ… Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²."
  ],
  panic: [
    "Ğ¡Ğ¢ĞĞŸ Ğ¡Ğ¢ĞĞŸ! ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ²ÑĞµ Ğ½Ğ° Ğ¼ĞµĞ½Ñ ÑĞ¼Ğ¾Ñ‚Ñ€ÑÑ‚?!",
    "Ğ¯ Ğ½Ğµ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ñ Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚. Ğ­Ñ‚Ğ¾ Ğ½ĞµÑ‡ĞµÑÑ‚Ğ½Ğ¾!",
    "Ğ’Ñ‹ Ğ²ÑĞµ ÑĞ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ¼ĞµĞ½Ñ?! Ğ¡ĞµÑ€ÑŒÑ‘Ğ·Ğ½Ğ¾?!",
    "Ğ¯ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹! ĞšĞ»ÑĞ½ÑƒÑÑŒ! ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ½Ğ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ²ĞµÑ€Ğ¸Ñ‚?!",
    "Ğ­Ñ‚Ğ¾ ĞºĞ°ĞºĞ¾Ğ¹-Ñ‚Ğ¾ Ğ°Ğ±ÑÑƒÑ€Ğ´... Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¼ĞµĞ½Ñ Ñƒ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€Ğ°!",
    "ĞĞµÑ‚ Ğ½ĞµÑ‚ Ğ½ĞµÑ‚. Ğ­Ñ‚Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. Ğ’Ñ‹ Ñ‚ĞµÑ€ÑĞµÑ‚Ğµ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑƒĞ½Ğ´."
  ],
  mafia_deflect: [
    "ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ, Ğ½Ğµ Ñ‚Ğ°Ğº Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾. {t} Ğ³Ğ¾Ñ€Ğ°Ğ·Ğ´Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ĞµĞµ.",
    "Ğ’Ñ‹ ÑƒĞ¿ÑƒÑĞºĞ°ĞµÑ‚Ğµ Ğ¸Ğ· Ğ²Ğ¸Ğ´Ñƒ {t}. Ğ¢Ğ°Ğ¼ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ°Ñ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ°.",
    "Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ? ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ»ÑƒÑ‡ÑˆĞµ Ğ½Ğ° {t}.",
    "ĞœĞ½Ğµ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ, Ğ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ ÑƒĞ²Ğ¾Ğ´ÑÑ‚ Ğ¾Ñ‚ {t}.",
    "Ğ˜Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ğ¾, Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ Ğ½Ğ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾ {t}?",
    "{t} Ğ²Ñ‹Ğ³Ğ¾Ğ´ĞµĞ½ ÑÑ‚Ğ¾Ñ‚ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€. Ğ—Ğ°Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ."
  ],
  mafia_sacrifice: [
    "Ğ›Ğ°Ğ´Ğ½Ğ¾, Ñ€Ğ°Ğ· ÑƒĞ¶ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ â€” Ğ»ÑƒÑ‡ÑˆĞµ {t}.",
    "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾. {t} Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ²Ñ‘Ğ» ÑĞµĞ±Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ½Ğ¾ Ğ² Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ.",
    "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹, ÑĞ¾Ğ³Ğ»Ğ°ÑˆÑƒÑÑŒ. {t} Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ Ğ¼Ğ¾Ñ‘ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ».",
    "ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ {t} ĞºĞ°Ğº ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ° Ğ½Ğ° Ğ²Ñ‹Ñ…Ğ¾Ğ´.",
  ],
  open_day: [
    "Ğ”Ğ¾Ğ±Ñ€Ğ¾Ğµ ÑƒÑ‚Ñ€Ğ¾, Ğ³Ğ¾Ñ€Ğ¾Ğ´. ĞšÑ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ Ğ²Ñ‹ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒÑÑ?",
    "ĞĞ¾Ñ‡ÑŒ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°. ĞÑƒĞ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¼Ğ°Ñ„Ğ¸Ñ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¾.",
    "ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ. Ğ£ ĞºĞ¾Ğ³Ğ¾ ĞµÑÑ‚ÑŒ Ğ²ĞµÑ€ÑĞ¸Ğ¸?",
    "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾, Ğ²Ñ€ĞµĞ¼Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ. ĞšÑ‚Ğ¾ Ñ‡Ñ‚Ğ¾ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ»?",
    "ĞĞµ Ñ‚ĞµÑ€ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ â€” Ğ¼Ğ°Ñ„Ğ¸Ñ ÑÑ€ĞµĞ´Ğ¸ Ğ½Ğ°Ñ."
  ],
  night_kill_comment: [
    "Ğ–Ğ°Ğ»ĞºĞ¾ {t}. ĞĞ¾ ÑÑ‚Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒĞºÑ€ĞµĞ¿Ğ»ÑĞµÑ‚ Ğ¼Ğ¾Ğ¸ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ñ Ğ½Ğ°ÑÑ‡Ñ‘Ñ‚...",
    "ĞœĞ°Ñ„Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ° {t}. Ğ—Ğ½Ğ°Ñ‡Ğ¸Ñ‚, {t} Ğ±Ñ‹Ğ» Ğ¾Ğ¿Ğ°ÑĞµĞ½ Ğ´Ğ»Ñ Ğ½Ğ¸Ñ….",
    "ĞŸĞ¾Ñ‚ĞµÑ€ÑĞ»Ğ¸ {t}. Ğ”ÑƒĞ¼Ğ°Ñ, Ğ¼Ğ°Ñ„Ğ¸Ñ ÑƒĞ±Ñ€Ğ°Ğ»Ğ° ÑƒĞ³Ñ€Ğ¾Ğ·Ñƒ.",
    "ĞĞ½Ğ¸ ÑƒĞ±Ğ¸Ğ»Ğ¸ {t}? Ğ˜Ğ½Ñ‚ĞµÑ€ĞµÑĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€. Ğ—Ğ½Ğ°Ñ‡Ğ¸Ñ‚ {t} Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ğ».",
    "RIP {t}. ĞœĞ°Ñ„Ğ¸Ñ Ğ·Ğ½Ğ°Ğ»Ğ° Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚.",
  ],
  analytical: [
    "Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ½Ğ° Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ â€” ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½Ğ° ÑÑĞ½Ğ°.",
    "ĞŸĞ¾ Ğ»Ğ¾Ğ³Ğ¸ĞºĞµ â€” Ñ‚Ğ¾Ñ‚, ĞºÑ‚Ğ¾ Ğ¼Ğ¾Ğ»Ñ‡Ğ¸Ñ‚ Ğ´Ğ¾Ğ»ÑŒÑˆĞµ Ğ²ÑĞµÑ…, Ğ¸Ğ¼ĞµĞµÑ‚ Ñ‡Ñ‚Ğ¾ ÑĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ.",
    "ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼: ĞºÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ¾Ğ±Ğ²Ğ¸Ğ½ÑÑ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ½Ğ¾Ñ‡Ğ¸?",
    "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ â€” ÑĞ°Ğ¼Ñ‹Ğµ Ñ‚Ğ¸Ñ…Ğ¸Ğµ Ñ‡Ğ°Ñ‰Ğµ Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ¼Ğ°Ñ„Ğ¸ĞµĞ¹.",
    "Ğ¤Ğ°ĞºÑ‚Ñ‹: {t} Ğ½Ğ¸ Ñ€Ğ°Ğ·Ñƒ Ğ½Ğµ Ğ¾Ğ±Ğ²Ğ¸Ğ½Ğ¸Ğ» Ğ¾Ñ‡ĞµĞ²Ğ¸Ğ´Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾."
  ]
};

function getRandMsg(type, replaceVars={}) {
  const arr = MSG_TEMPLATES[type];
  let s = arr[Math.floor(Math.random()*arr.length)];
  for(const [k,v] of Object.entries(replaceVars)) s = s.replace(new RegExp(`{${k}}`,'g'), v);
  return s;
}

function generateBotMessage(botIdx) {
  const bot = G.players[botIdx];
  const p = bot.profile;
  if(!p) return null;
  const alive = G.players.filter(x=>!x.eliminated);
  const target = getMostSuspectFor(botIdx);
  const targetName = target >= 0 ? G.players[target].name : 'ĞºÑ‚Ğ¾-Ñ‚Ğ¾';
  let msgType, msg;

  // High accusation suspicion on bot â†’ panic
  const botSuspicion = G.players.filter(x=>!x.eliminated && x.idx!==botIdx).reduce((acc,x) => acc + (x.botSuspicion?.[botIdx]||0.3), 0) / Math.max(1,alive.length-1);
  const isPanicking = botSuspicion > 0.65 && p.emotionalVolatility > 0.5;

  if(isPanicking && Math.random() < 0.6) {
    msgType = 'panic';
    msg = getRandMsg('panic');
    updateSuspicion(botIdx, 0.04, 'panic_detected');
  } else if(bot.role === ROLES.MAFIA) {
    // Mafia strategy
    if(target === G.humanIdx && Math.random() < 0.4 + p.aggression*0.3) {
      msgType = 'mafia_deflect';
      const deflectTarget = G.players.filter((x,i)=>!x.eliminated && i!==botIdx && i!==G.players.findIndex(pp=>pp.role===ROLES.MAFIA)).slice(0,1)[0];
      msg = getRandMsg('mafia_deflect', { t: deflectTarget ? deflectTarget.name : targetName });
    } else if(Math.random() < p.manipulation*0.5) {
      // Sacrifice a mafia partner if needed
      const mafiaPartners = G.players.filter((x,i)=>!x.eliminated && i!==botIdx && x.role===ROLES.MAFIA);
      if(mafiaPartners.length > 0 && Math.random() < 0.2) {
        msg = getRandMsg('mafia_sacrifice', { t: mafiaPartners[0].name });
      } else {
        msg = getRandMsg('mafia_deflect', { t: targetName });
      }
    } else {
      msg = getRandMsg('accusation', { t: targetName });
    }
  } else if(bot.role === ROLES.SHERIFF && G.sheriffChecks.length > 0) {
    const lastCheck = G.sheriffChecks[G.sheriffChecks.length-1];
    if(lastCheck.isMafia && !lastCheck.revealed && Math.random() < 0.6+p.confidence*0.3) {
      msg = `ĞšĞ°Ğº ĞºĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€, Ğ·Ğ°ÑĞ²Ğ»ÑÑ: ${G.players[lastCheck.target].name} â€” ĞœĞĞ¤Ğ˜Ğ¯. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ!`;
      lastCheck.revealed = true;
      updateSuspicion(lastCheck.target, 0.25, 'sheriff_exposed');
    } else if(!lastCheck.isMafia) {
      msg = `Ğ¯ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ» ${G.players[lastCheck.target].name} â€” Ğ¾Ğ½ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹.`;
      updateSuspicion(lastCheck.target, -0.15, 'sheriff_cleared');
    } else {
      msg = getRandMsg('accusation', { t: targetName });
    }
  } else {
    // Civilian / Doctor
    const r = Math.random();
    if(r < 0.35 + p.aggression*0.2 && target >= 0) {
      msg = getRandMsg('accusation', { t: targetName });
      if(G.mode === 'hardcore') msg = getRandMsg('analytical', { t: targetName });
    } else if(r < 0.55) {
      msg = getRandMsg('defense_self');
    } else if(r < 0.7 && alive.length > 2) {
      // Agree with someone
      const other = alive.filter(x=>x.idx!==botIdx)[Math.floor(Math.random()*alive.length)];
      msg = getRandMsg('agreement', { t: other ? other.name : 'Ñ‚ĞµĞ±Ñ' });
    } else {
      msg = getRandMsg('doubt');
    }
  }
  if(!msg) msg = getRandMsg('accusation', { t: targetName });

  // Theater mode: add dramatic flair
  if(G.mode === 'theater' && Math.random() < 0.4) {
    const flair = ['...Ğ­Ñ‚Ğ¾ Ğ½ĞµĞ²Ñ‹Ğ½Ğ¾ÑĞ¸Ğ¼Ğ¾.','Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ² Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸!','Ğ¯ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒÑ Ğ»Ğ¾Ğ¶ÑŒ.','Ğ’ÑĞµ Ğ²Ğ¸Ğ´ÑÑ‚ ÑÑ‚Ğ¾?','ĞĞµÑ‚ ÑĞ»Ğ¾Ğ².'];
    msg += ' ' + flair[Math.floor(Math.random()*flair.length)];
  }
  return msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let synthesis = window.speechSynthesis;
let recognition = null;
let isListening = false;

function speak(text, rate=null) {
  if(!G.voiceEnabled || !synthesis) return;
  synthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ru-RU';
  utter.rate = rate || G.speechRate;
  utter.pitch = 0.9 + Math.random()*0.2;
  const voices = synthesis.getVoices();
  const ruVoice = voices.find(v => v.lang.startsWith('ru') || v.name.includes('Russian') || v.name.includes('Milena') || v.name.includes('Irina'));
  if(ruVoice) utter.voice = ruVoice;
  synthesis.speak(utter);
}

function toggleMic() {
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { showToast('Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ²Ğ²Ğ¾Ğ´ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ','error'); return; }
  if(isListening) { recognition.stop(); return; }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ru-RU';
  recognition.interimResults = false;
  recognition.onresult = e => { document.getElementById('chatInput').value = e.results[0][0].transcript; };
  recognition.onend = () => { isListening = false; document.getElementById('btnMic').classList.remove('active'); };
  recognition.onerror = () => { isListening = false; document.getElementById('btnMic').classList.remove('active'); showToast('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ñ','error'); };
  recognition.start();
  isListening = true;
  document.getElementById('btnMic').classList.add('active');
}

function toggleVoice() { G.voiceEnabled = document.getElementById('voiceCheck').checked; }
function updateSpeechRate(v) { G.speechRate = parseFloat(v); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  const el = document.getElementById('screen-'+id);
  if(el) { el.classList.remove('hidden'); }
}

function showToast(msg, type='') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast' + (type ? ' '+type : '');
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

function phaseFlashAnim(isNight) {
  const el = document.getElementById('phaseFlash');
  el.className = 'phase-flash ' + (isNight ? 'night' : 'day') + ' anim';
  setTimeout(()=>el.className='phase-flash', 1600);
}

function addMessage(senderIdx, text, special=null) {
  const chat = document.getElementById('chatArea');
  const msg = document.createElement('div');
  if(special) {
    msg.className = `msg ${special}-msg`;
    msg.innerHTML = `<div class="msg-body"><div class="msg-text">${text}</div></div>`;
  } else {
    const p = senderIdx >= 0 ? G.players[senderIdx] : null;
    const isHuman = senderIdx === G.humanIdx;
    msg.className = `msg ${isHuman ? 'human-msg' : ''}`;
    const roleInfo = p ? ROLE_DISPLAY[p.role] : null;
    const roleTag = p && p.eliminated ? `<span class="msg-role-tag" style="background:${roleInfo?.color}22;color:${roleInfo?.color}">${roleInfo?.name}</span>` : '';
    const personTag = p && p.personality && !isHuman ? `<span style="font-size:0.6rem;color:var(--text-muted)">${PERSONALITY_LABELS[p.personality]||''}</span>` : '';
    msg.innerHTML = `
      <div class="msg-avatar" style="background:${p?.color||'#334'}22;border:1px solid ${p?.color||'#334'}44">${p?.avatar||'ğŸ‘¤'}</div>
      <div class="msg-body">
        <div class="msg-header">
          <span class="msg-name" style="color:${p?.color||'var(--text-primary)'}">${p?.name||'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ°'}</span>
          ${roleTag}
          ${personTag}
          <span class="msg-time">${new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div class="msg-text">${escapeHtml(text)}</div>
      </div>`;
  }
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

async function addBotMessageAnimated(botIdx, text) {
  const chat = document.getElementById('chatArea');
  const p = G.players[botIdx];
  const roleInfo = ROLE_DISPLAY[p.role];
  const msg = document.createElement('div');
  msg.className = 'msg';
  msg.innerHTML = `
    <div class="msg-avatar" style="background:${p.color}22;border:1px solid ${p.color}44">${p.avatar}</div>
    <div class="msg-body">
      <div class="msg-header">
        <span class="msg-name" style="color:${p.color}">${p.name}</span>
        <span style="font-size:0.6rem;color:var(--text-muted)">${PERSONALITY_LABELS[p.personality]||''}</span>
        <span class="msg-time">${new Date().toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</span>
      </div>
      <div class="msg-text typing">
        <span class="thinking-dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
    </div>`;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
  // Random thinking pause
  const thinkTime = 600 + Math.random()*1200 + (p.profile?.verbosity||0.5)*400;
  await sleep(thinkTime);
  const textEl = msg.querySelector('.msg-text');
  textEl.className = 'msg-text';
  textEl.textContent = text;
  chat.scrollTop = chat.scrollHeight;
  // Speak
  if(G.voiceEnabled) {
    await sleep(100 + Math.random()*300);
    speak(text);
  }
  // Update suspicion from bot's message
  parsePlayerMessage(text, botIdx);
  renderSuspicion();
}

function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function addLog(text, type='') {
  G.gameLog.unshift({ text, type, round:G.round });
  renderLog();
}

function renderLog() {
  const el = document.getElementById('gameLog');
  el.innerHTML = G.gameLog.slice(0,10).map(l=>`<div class="log-item ${l.type}">${l.text}</div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYERS RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYER_COLORS = ['#e8274b','#3d7fff','#f0a500','#2ecc71','#9b59b6','#e67e22','#1abc9c','#e91e8c','#00bcd4','#ff5722'];

function renderPlayers() {
  const area = document.getElementById('playersArea');
  area.innerHTML = G.players.map((p,i) => {
    const roleInfo = ROLE_DISPLAY[p.role];
    const susp = p.suspicion;
    const suspClass = susp < 0.4 ? 'low' : susp < 0.65 ? 'mid' : 'high';
    const showRole = p.eliminated || i === G.humanIdx;
    return `<div class="player-card ${p.eliminated?'eliminated':''} ${i===G.humanIdx?'human-card':''} ${G.phase===PHASES.VOTE&&!p.eliminated&&i!==G.humanIdx?'vote-on':''}" id="pc-${i}" onclick="selectPlayer(${i})">
      <div class="pc-status ${p.eliminated?'status-dead':'status-alive'}"></div>
      ${G.phase===PHASES.VOTE&&!p.eliminated?`<div class="pc-vote-indicator" id="vi-${i}">0</div>`:''}
      <div class="pc-avatar" style="background:${p.color}22;border:1px solid ${p.color}44">${p.avatar}</div>
      <div class="pc-name" style="color:${i===G.humanIdx?'var(--accent-blue)':p.color}">${p.name}${i===G.humanIdx?' (Ğ’Ñ‹)':''}</div>
      ${showRole ? `<div class="pc-role-badge" style="background:${roleInfo.color}22;color:${roleInfo.color}">${roleInfo.icon} ${roleInfo.name}</div>` : `<div class="pc-role-badge" style="background:var(--border);color:var(--text-muted)">Ğ Ğ¾Ğ»ÑŒ ÑĞºÑ€Ñ‹Ñ‚Ğ°</div>`}
      ${p.personality&&i!==G.humanIdx?`<div class="personality-tag">${PERSONALITY_LABELS[p.personality]||''}</div>`:''}
      <div class="pc-susp"><div class="pc-susp-fill ${suspClass}" style="width:${Math.round(susp*100)}%"></div></div>
    </div>`;
  }).join('');
}

function renderSuspicion() {
  const el = document.getElementById('suspList');
  const sorted = [...G.players].filter(p=>!p.eliminated).sort((a,b)=>b.suspicion-a.suspicion);
  el.innerHTML = sorted.map(p=>{
    const pct = Math.round(p.suspicion*100);
    const cls = pct<40?'low':pct<65?'mid':'high';
    return `<div class="susp-item">
      <span class="susp-name" style="color:${p.idx===G.humanIdx?'var(--accent-blue)':p.color}">${p.name}</span>
      <div class="susp-bar"><div class="susp-bar-fill ${cls}" style="width:${pct}%"></div></div>
      <span class="susp-pct">${pct}%</span>
    </div>`;
  }).join('');
  renderPlayers();
}

function renderCounts() {
  const alive = G.players.filter(p=>!p.eliminated);
  const mafiaAlive = alive.filter(p=>p.role===ROLES.MAFIA).length;
  const civilAlive = alive.filter(p=>p.role!==ROLES.MAFIA).length;
  document.getElementById('countAlive').textContent = alive.length;
  document.getElementById('countMafia').textContent = G.phase===PHASES.END ? mafiaAlive : '?';
  document.getElementById('countCivil').textContent = civilAlive;
}

function renderPhase(title, sub, isNight=false) {
  document.getElementById('phaseTitle').textContent = title;
  document.getElementById('phaseSub').textContent = sub;
  document.getElementById('roundLabel').textContent = `Ğ ĞĞ£ĞĞ” ${G.round}`;
  const icon = document.getElementById('phaseIcon');
  if(isNight) { icon.textContent = 'ğŸŒ™'; icon.className = 'phase-icon'; }
  else { icon.textContent = 'â˜€ï¸'; icon.className = 'phase-icon day'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let setupConfig = { playerCount:8, mode:'normal', voiceEnabled:1 };

function setOpt(key, val, btn) {
  setupConfig[key] = val;
  btn.closest('.setup-options').querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function setMode(mode, card) {
  setupConfig.mode = mode;
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('active'));
  card.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame() {
  const humanName = document.getElementById('playerName').value.trim() || 'Ğ˜Ğ³Ñ€Ğ¾Ğº';
  G = { ...G, players:[], phase:PHASES.SETUP, round:1, votes:{}, nightKillTarget:null, nightSaveTarget:null, nightCheckTarget:null, gameLog:[], sheriffChecks:[], totalEliminations:0, correctAccusations:0, gameStartTime:Date.now(), settings:{playerCount:setupConfig.playerCount} };
  G.mode = setupConfig.mode;
  G.voiceEnabled = setupConfig.voiceEnabled === 1;
  document.getElementById('voiceCheck').checked = G.voiceEnabled;

  const count = setupConfig.playerCount;
  const rc = ROLE_CONFIG[count];
  const roles = [];
  for(let i=0; i<rc.mafia; i++) roles.push(ROLES.MAFIA);
  roles.push(ROLES.SHERIFF);
  roles.push(ROLES.DOCTOR);
  for(let i=0; i<rc.civilian; i++) roles.push(ROLES.CIVILIAN);
  // Shuffle roles
  for(let i=roles.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[roles[i],roles[j]]=[roles[j],roles[i]];}

  const usedNames = [];
  const personalities = [...PERSONALITY_TYPES];
  for(let i=0;i<count;i++) {
    const isHuman = i===0;
    let name = isHuman ? humanName : BOT_NAMES.filter(n=>!usedNames.includes(n))[0];
    if(!name) name = 'Ğ˜Ğ³Ñ€Ğ¾Ğº'+(i+1);
    usedNames.push(name);
    const personality = personalities[Math.floor(Math.random()*personalities.length)];
    const profile = isHuman ? null : createBotProfile(personality, G.mode);
    G.players.push({
      idx:i, name, role:roles[i], avatar:BOT_AVATARS[i%BOT_AVATARS.length],
      color:PLAYER_COLORS[i%PLAYER_COLORS.length], isBot:!isHuman,
      eliminated:false, suspicion:0.3+Math.random()*0.15, profile, personality: isHuman ? null : personality,
      memory:initMemory(), botSuspicion:{}
    });
  }
  G.humanIdx = 0;

  // Reveal roles to bots (internal)
  G.players.forEach((p,i)=>{ if(p.isBot) recalcBotSuspicion(i); });

  showScreen('game');
  document.getElementById('actionBar').style.display = 'flex';
  renderModeDisplay();
  // Show my role
  const me = G.players[G.humanIdx];
  const ri = ROLE_DISPLAY[me.role];
  document.getElementById('myRoleIcon').textContent = ri.icon;
  document.getElementById('myRoleName').textContent = ri.name;
  document.getElementById('myRoleDesc').textContent = ri.desc;
  document.getElementById('myRoleCard').style.borderColor = ri.color;

  showToast(`Ğ’Ğ°ÑˆĞ° Ñ€Ğ¾Ğ»ÑŒ: ${ri.name} ${ri.icon}`);
  addMessage(-1, 'ğŸ® Ğ˜Ğ³Ñ€Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°ÑÑŒ! Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² ĞœĞ°Ñ„Ğ¸Ñ.', 'system');

  startNightPhase();
}

function renderModeDisplay() {
  const el = document.getElementById('gameModeDisplay');
  if(G.mode === 'normal') { el.innerHTML = ''; return; }
  const modes = { paranoia:'ĞŸĞ°Ñ€Ğ°Ğ½Ğ¾Ğ¹Ñ', manipulators:'ĞœĞ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ‚Ğ¾Ñ€Ñ‹', hardcore:'Ğ¥Ğ°Ñ€Ğ´ĞºĞ¾Ñ€', chaos:'Ğ¥Ğ°Ğ¾Ñ', theater:'Ğ¢ĞµĞ°Ñ‚Ñ€', psychology:'ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ' };
  el.innerHTML = `<span class="mode-badge ${G.mode}">â–¶ ${modes[G.mode]||G.mode}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NIGHT PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startNightPhase() {
  G.phase = PHASES.NIGHT;
  phaseFlashAnim(true);
  renderPhase(`ĞĞ¾Ñ‡ÑŒ ${G.round}`, 'Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°ĞµÑ‚...', true);
  renderCounts();
  document.getElementById('voteOverlay').classList.remove('active');
  addMessage(-1, `ğŸŒ™ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ°ĞµÑ‚ ĞĞ¾Ñ‡ÑŒ ${G.round}. Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°ĞµÑ‚...`, 'phase');
  addLog(`ĞĞ¾Ñ‡ÑŒ ${G.round} Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ`, '');
  await sleep(1500);

  // Show night overlay
  const overlay = document.getElementById('nightOverlay');
  const nightResult = document.getElementById('nightResult');
  const btnContinue = document.getElementById('btnContinue');
  nightResult.className = 'night-result';
  nightResult.style.display = 'none';
  btnContinue.className = 'btn-continue';
  btnContinue.style.display = 'none';

  const me = G.players[G.humanIdx];
  document.getElementById('nightTitle').textContent = 'ğŸŒ™ ĞĞĞ§Ğ¬ ' + G.round;

  const alive = G.players.filter(p=>!p.eliminated && p.idx!==G.humanIdx);

  if(me.role === ROLES.MAFIA) {
    document.getElementById('nightSub').textContent = 'ĞœĞ°Ñ„Ğ¸Ñ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¶ĞµÑ€Ñ‚Ğ²Ñƒ...';
    document.getElementById('nightActionTitle').textContent = 'ğŸ”« Ğ’Ğ«Ğ‘Ğ•Ğ Ğ˜Ğ¢Ğ• Ğ–Ğ•Ğ Ğ¢Ğ’Ğ£';
    const targets = alive.filter(p=>p.role!==ROLES.MAFIA);
    renderNightTargets(targets, 'kill');
    overlay.classList.add('active');
  } else if(me.role === ROLES.DOCTOR) {
    document.getElementById('nightSub').textContent = 'Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ĞºĞ¾Ğ³Ğ¾ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¸Ñ‚ÑŒ...';
    document.getElementById('nightActionTitle').textContent = 'ğŸ’‰ ĞšĞĞ“Ğ Ğ—ĞĞ©Ğ˜Ğ¢Ğ˜Ğ¢Ğ¬?';
    renderNightTargets(G.players.filter(p=>!p.eliminated), 'save');
    overlay.classList.add('active');
  } else if(me.role === ROLES.SHERIFF) {
    document.getElementById('nightSub').textContent = 'ĞšĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ...';
    document.getElementById('nightActionTitle').textContent = 'ğŸ” ĞšĞĞ“Ğ ĞŸĞ ĞĞ’Ğ•Ğ Ğ˜Ğ¢Ğ¬?';
    const unchecked = alive.filter(p=>!G.sheriffChecks.some(c=>c.target===p.idx));
    renderNightTargets(unchecked.length ? unchecked : alive, 'check');
    overlay.classList.add('active');
  } else {
    // Civilian sleeps
    document.getElementById('nightSub').textContent = 'ĞœĞ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ ÑĞ¿Ğ¸Ñ‚...';
    document.getElementById('nightActionTitle').textContent = 'Ğ’Ñ‹ ÑĞ¿Ğ¸Ñ‚Ğµ Ğ²ÑÑ Ğ½Ğ¾Ñ‡ÑŒ';
    document.getElementById('nightTargets').innerHTML = '<div style="color:var(--text-muted);font-size:0.8rem;padding:16px;">Ğ’Ñ‹ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑĞ²ĞµÑ‚Ğ°.</div>';
    overlay.classList.add('active');
    // Auto-continue for civilian after delay
    setTimeout(()=>{ processNightBotActions(); }, 2000);
  }
}

function renderNightTargets(targets, actionType) {
  const el = document.getElementById('nightTargets');
  const isSave = actionType==='save';
  el.innerHTML = targets.map(p=>`
    <button class="night-target-btn ${isSave?'doctor-btn':''}" onclick="nightAction(${p.idx},'${actionType}')">
      <span style="font-size:1.2rem">${p.avatar}</span>
      <span style="color:${p.color}">${p.name}</span>
      <span style="font-size:0.65rem;color:var(--text-muted);margin-left:auto">${p.personality?PERSONALITY_LABELS[p.personality]:''}</span>
    </button>`).join('');
  // Skip button
  el.innerHTML += `<button class="night-skip-btn" onclick="nightAction(-1,'${actionType}')">ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ</button>`;
}

function nightAction(targetIdx, type) {
  if(type==='kill') {
    G.nightKillTarget = targetIdx;
    showToast(targetIdx>=0?`Ğ¦ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ°: ${G.players[targetIdx].name}`:'ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚Ğµ Ñ…Ğ¾Ğ´');
  } else if(type==='save') {
    G.nightSaveTarget = targetIdx;
    showToast(targetIdx>=0?`Ğ—Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚Ğµ: ${G.players[targetIdx].name}`:'ĞĞ¸ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚Ğµ');
  } else if(type==='check') {
    G.nightCheckTarget = targetIdx;
    if(targetIdx>=0) {
      const p = G.players[targetIdx];
      const isMafia = p.role === ROLES.MAFIA;
      G.sheriffChecks.push({ target:targetIdx, isMafia, round:G.round, revealed:false });
      const res = document.getElementById('nightResult');
      res.innerHTML = isMafia ? `<span class="found-mafia">âš  ${p.name} â€” ĞœĞĞ¤Ğ˜Ğ¯!</span>` : `<span class="found-civil">âœ“ ${p.name} â€” ĞœĞ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ.</span>`;
      res.style.display = 'block';
      res.className = 'night-result show';
      addLog(`Ğ Ğ°ÑƒĞ½Ğ´ ${G.round}: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½ ${p.name} â†’ ${isMafia?'ĞœĞĞ¤Ğ˜Ğ¯':'Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹'}`, 'check');
    }
  }
  processNightBotActions();
}

async function processNightBotActions() {
  // Bot mafia choose kill
  const mafiaBot = G.players.find(p=>p.isBot && p.role===ROLES.MAFIA && !p.eliminated);
  if(mafiaBot && G.nightKillTarget === null) {
    const targets = G.players.filter(p=>!p.eliminated && p.role!==ROLES.MAFIA);
    if(targets.length > 0) {
      // Target highest suspicion non-mafia (threat to mafia)
      const threat = targets.reduce((best, p) => {
        const s = (mafiaBot.botSuspicion||{})[p.idx] !== undefined ? (1-(mafiaBot.botSuspicion[p.idx])) : (1-p.suspicion);
        const bests = (mafiaBot.botSuspicion||{})[best.idx] !== undefined ? (1-(mafiaBot.botSuspicion[best.idx])) : (1-best.suspicion);
        return s < bests ? p : best;
      }, targets[0]);
      G.nightKillTarget = threat.idx;
    }
  }
  // Bot doctor choose save
  const doctorBot = G.players.find(p=>p.isBot && p.role===ROLES.DOCTOR && !p.eliminated);
  if(doctorBot && G.nightSaveTarget === null) {
    const targets = G.players.filter(p=>!p.eliminated);
    const saveTarget = targets[Math.floor(Math.random()*targets.length)];
    G.nightSaveTarget = saveTarget?.idx ?? -1;
  }
  // Bot sheriff check
  const sheriffBot = G.players.find(p=>p.isBot && p.role===ROLES.SHERIFF && !p.eliminated);
  if(sheriffBot && G.nightCheckTarget === null) {
    const unchecked = G.players.filter(p=>!p.eliminated && p.idx!==sheriffBot.idx && !G.sheriffChecks.some(c=>c.target===p.idx));
    if(unchecked.length > 0) {
      const target = getMostSuspectFor(sheriffBot.idx);
      const t = unchecked.find(p=>p.idx===target) || unchecked[Math.floor(Math.random()*unchecked.length)];
      G.nightCheckTarget = t.idx;
      const isMafia = t.role === ROLES.MAFIA;
      G.sheriffChecks.push({ target:t.idx, isMafia, round:G.round, revealed:false });
      addLog(`ĞĞ¾Ñ‡ÑŒ ${G.round}: ĞšĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ» ${t.name} â†’ ${isMafia?'ĞœĞĞ¤Ğ˜Ğ¯':'Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹'}`, 'check');
    }
  }
  // Show continue button
  const btnContinue = document.getElementById('btnContinue');
  btnContinue.style.display = 'block';
  btnContinue.className = 'btn-continue show';
}

async function continueFromNight() {
  document.getElementById('nightOverlay').classList.remove('active');
  await sleep(400);
  // Apply night results
  const killed = G.nightKillTarget;
  const saved = G.nightSaveTarget;
  G.nightKillTarget = null; G.nightSaveTarget = null; G.nightCheckTarget = null;
  let killedPlayer = null;
  if(killed >= 0 && killed !== saved) {
    killedPlayer = G.players[killed];
    killedPlayer.eliminated = true;
    G.totalEliminations++;
    addLog(`ĞĞ¾Ñ‡ÑŒ ${G.round}: ${killedPlayer.name} ÑƒĞ±Ğ¸Ñ‚`, 'kill');
  } else if(killed === saved) {
    addLog(`ĞĞ¾Ñ‡ÑŒ ${G.round}: Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€ ÑĞ¿Ğ°Ñ Ğ¶ĞµÑ€Ñ‚Ğ²Ñƒ`, 'save');
  }
  startDayPhase(killedPlayer);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAY PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startDayPhase(killedPlayer=null) {
  G.phase = PHASES.DAY;
  phaseFlashAnim(false);
  renderPhase(`Ğ”ĞµĞ½ÑŒ ${G.round}`, 'ĞĞ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ', false);
  renderPlayers();
  renderCounts();
  addMessage(-1, `â˜€ï¸ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ°ĞµÑ‚ Ğ”ĞµĞ½ÑŒ ${G.round}. Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ...`, 'day-phase');

  if(killedPlayer) {
    const ri = ROLE_DISPLAY[killedPlayer.role];
    addMessage(-1, `ğŸ’€ Ğ­Ñ‚Ğ¾Ğ¹ Ğ½Ğ¾Ñ‡ÑŒÑ Ğ±Ñ‹Ğ» ÑƒĞ±Ğ¸Ñ‚ ${killedPlayer.name} (${ri.name} ${ri.icon}). Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ² Ñ‚Ñ€Ğ°ÑƒÑ€Ğµ.`, 'result');
    addLog(`Ğ”ĞµĞ½ÑŒ ${G.round}: ${killedPlayer.name} (${ri.name}) ÑƒĞ±Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½Ğ¾Ñ‡ÑŒÑ`, 'kill');
    renderSuspicion();
    // Bots react to kill
    await sleep(1500);
    const reactBot = G.players.filter(p=>p.isBot&&!p.eliminated)[Math.floor(Math.random()*3)];
    if(reactBot) await addBotMessageAnimated(reactBot.idx, getRandMsg('night_kill_comment', {t:killedPlayer.name}));
  } else if(G.round > 1) {
    addMessage(-1, `ğŸŒ™ ĞŸÑ€Ğ¾ÑˆĞ»Ğ°Ñ Ğ½Ğ¾Ñ‡ÑŒ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ğ¾. ĞĞ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ´Ğ°Ğ».`, 'result');
  }

  if(checkWinCondition()) return;

  // Update all suspicions
  updateAllSuspicions();
  // Open day chat
  addMessage(-1, 'ğŸ’¬ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ. Ğ’Ñ‹ÑĞ²Ğ»ÑĞ¹Ñ‚Ğµ Ğ¼Ğ°Ñ„Ğ¸Ñ!', 'day-phase');
  await sleep(800);
  // Bot discussion (3-6 messages)
  await runBotDiscussion();
}

async function runBotDiscussion() {
  const alive = G.players.filter(p=>p.isBot&&!p.eliminated);
  const numMessages = 3 + Math.floor(Math.random()*3) + (G.mode==='theater'?2:0);
  for(let i=0; i<Math.min(numMessages, alive.length); i++) {
    const bot = alive[Math.floor(Math.random()*alive.length)];
    const msg = generateBotMessage(bot.idx);
    if(msg) await addBotMessageAnimated(bot.idx, msg);
    await sleep(300 + Math.random()*500);
    if(G.phase !== PHASES.DAY) break;
  }
  if(G.phase === PHASES.DAY) startVotePhase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOTING PHASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startVotePhase() {
  G.phase = PHASES.VOTE;
  G.votes = {};
  renderPhase(`Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ`, 'ĞŸÑ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑÑƒĞ¹Ñ‚Ğµ Ğ·Ğ° Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ²Ğ°ĞµĞ¼Ğ¾Ğ³Ğ¾', false);
  addMessage(-1, 'ğŸ—³ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ! Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ, ĞºĞ¾Ğ³Ğ¾ Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°.', 'day-phase');

  // Show vote overlay
  const overlay = document.getElementById('voteOverlay');
  const candidates = document.getElementById('voteCandidates');
  const alive = G.players.filter(p=>!p.eliminated);
  candidates.innerHTML = alive.map(p=>`
    <button class="vote-btn ${p.idx===G.humanIdx?'':''}${p.idx===G.humanIdx?'disabled':''}" id="vb-${p.idx}" 
      onclick="castHumanVote(${p.idx})" ${p.idx===G.humanIdx?'disabled':''}>
      ${p.avatar} ${p.name}
    </button>`).join('') + `<button class="vote-skip-btn" onclick="castHumanVote(-1)">Ğ’Ğ¾Ğ·Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒÑÑ</button>`;
  overlay.classList.add('active');
  renderPlayers();

  // Bots vote
  await sleep(1000);
  await runBotVoting();
}

async function runBotVoting() {
  const bots = G.players.filter(p=>p.isBot&&!p.eliminated);
  for(const bot of bots) {
    await sleep(400 + Math.random()*800);
    const target = getBotVoteTarget(bot.idx);
    G.votes[bot.idx] = target;
    recordVote(bot.idx, target);
    if(target >= 0) {
      const targetP = G.players[target];
      updateSuspicion(target, 0.04, 'received_vote');
      // Announce vote
      const voteMsg = target === G.humanIdx
        ? `Ğ¯ Ğ³Ğ¾Ğ»Ğ¾ÑÑƒÑ Ğ·Ğ° ${targetP.name}.`
        : `Ğ“Ğ¾Ğ»Ğ¾ÑÑƒÑ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² ${targetP.name}. ${Math.random()<0.4?'Ğ£Ğ²ĞµÑ€ĞµĞ½ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¸.':''}`;
      await addBotMessageAnimated(bot.idx, voteMsg);
      // Update vote count display
      const voteCount = Object.values(G.votes).filter(v=>v===target).length;
      const vi = document.getElementById(`vi-${target}`);
      if(vi) vi.textContent = voteCount;
    }
  }
  // Wait for human if not voted
  const humanVoted = G.votes[G.humanIdx] !== undefined;
  if(!humanVoted) {
    addMessage(-1, 'â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ²Ğ°Ñˆ Ğ³Ğ¾Ğ»Ğ¾Ñ...', 'system');
  }
}

function getBotVoteTarget(botIdx) {
  const bot = G.players[botIdx];
  recalcBotSuspicion(botIdx);
  const alive = G.players.filter(p=>!p.eliminated&&p.idx!==botIdx);
  if(alive.length === 0) return -1;
  // Skip own mafia teammates
  const targets = bot.role===ROLES.MAFIA ? alive.filter(p=>p.role!==ROLES.MAFIA) : alive;
  if(!targets.length) return -1;
  // Weighted random based on suspicion
  const weights = targets.map(p=>{ const s=(bot.botSuspicion||{})[p.idx]||p.suspicion; return Math.max(0.01, s); });
  const total = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*total;
  for(let i=0;i<targets.length;i++){r-=weights[i];if(r<=0)return targets[i].idx;}
  return targets[targets.length-1].idx;
}

function castHumanVote(targetIdx) {
  if(G.phase !== PHASES.VOTE) return;
  G.votes[G.humanIdx] = targetIdx;
  document.querySelectorAll('.vote-btn').forEach(b=>b.classList.remove('voted'));
  if(targetIdx>=0) document.getElementById(`vb-${targetIdx}`)?.classList.add('voted');
  showToast(targetIdx>=0?`Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ¾Ñ‚Ğ´Ğ°Ğ½ Ğ·Ğ° ${G.players[targetIdx].name}`:'Ğ’Ğ¾Ğ·Ğ´ĞµÑ€Ğ¶Ğ°Ğ»Ğ¸ÑÑŒ');
  if(targetIdx>=0) { recordVote(G.humanIdx, targetIdx); updateSuspicion(targetIdx, 0.05, 'human_vote'); }
  // Close overlay and tally
  setTimeout(tallyVotes, 800);
}

async function tallyVotes() {
  document.getElementById('voteOverlay').classList.remove('active');
  await sleep(400);
  // Count votes
  const tally = {};
  G.players.forEach(p=>{ if(!p.eliminated) tally[p.idx]=0; });
  Object.values(G.votes).forEach(v=>{ if(v>=0) tally[v]=(tally[v]||0)+1; });
  const max = Math.max(...Object.values(tally));
  if(max === 0) { addMessage(-1,'ğŸ¤· ĞĞ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ±Ñ€Ğ°Ğ» Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ². Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ´Ğ°Ğ»Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°.','result'); endVotePhase(null); return; }
  const candidates = Object.keys(tally).filter(k=>tally[k]===max).map(Number);
  const eliminated = candidates.length===1 ? candidates[0] : candidates[Math.floor(Math.random()*candidates.length)];
  const ep = G.players[eliminated];

  addMessage(-1, `ğŸ—³ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ:`, 'result');
  const tStr = Object.entries(tally).filter(([k,v])=>v>0).map(([k,v])=>`${G.players[k].name}: ${v} Ğ³Ğ¾Ğ».`).join(', ');
  addMessage(-1, tStr, 'system');

  ep.eliminated = true;
  G.totalEliminations++;
  const ri = ROLE_DISPLAY[ep.role];
  addMessage(-1, `ğŸ‘¥ Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ¸ÑĞºĞ»ÑÑ‡Ğ¸Ğ» ${ep.name} (${ri.name} ${ri.icon}). ${ep.role===ROLES.MAFIA?'Ğ­Ñ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ° Ğ¼Ğ°Ñ„Ğ¸Ñ! ğŸ‰':'Ğ­Ñ‚Ğ¾ Ğ±Ñ‹Ğ» Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ...'}`,'result');
  addLog(`Ğ”ĞµĞ½ÑŒ ${G.round}: ${ep.name} (${ri.name}) Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼`, 'vote');
  if(ep.role===ROLES.MAFIA) G.correctAccusations++;
  renderPlayers(); renderSuspicion(); renderCounts();
  if(checkWinCondition()) return;
  endVotePhase(ep);
}

async function endVotePhase(eliminated) {
  G.round++;
  await sleep(2000);
  startNightPhase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUMAN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMessage() {
  if(G.phase !== PHASES.DAY && G.phase !== PHASES.VOTE) { showToast('Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°','error'); return; }
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  addMessage(G.humanIdx, text);
  parsePlayerMessage(text, G.humanIdx);
  renderSuspicion();
  // Bot reactions (sometimes)
  if(G.phase===PHASES.DAY && Math.random()<0.5) {
    setTimeout(async()=>{
      const bot = G.players.filter(p=>p.isBot&&!p.eliminated)[Math.floor(Math.random()*G.players.length)];
      if(bot) {
        // React to human's message
        let reaction = null;
        const m = text.toLowerCase();
        if(G.players.some(p=>!p.eliminated&&p.isBot&&m.includes(p.name.toLowerCase()))) {
          const mentioned = G.players.find(p=>!p.eliminated&&p.isBot&&m.includes(p.name.toLowerCase()));
          if(mentioned && mentioned.idx===bot.idx) {
            // Bot is being accused/mentioned â€” react
            if(bot.profile.emotionalVolatility > 0.6) reaction = getRandMsg('panic');
            else reaction = getRandMsg('defense_self');
          }
        }
        if(!reaction) reaction = generateBotMessage(bot.idx);
        await addBotMessageAnimated(bot.idx, reaction);
      }
    }, 800+Math.random()*1500);
  }
}

function selectPlayer(idx) {
  if(G.phase===PHASES.VOTE) return; // use vote overlay
  if(idx===G.humanIdx||G.players[idx].eliminated) return;
  document.querySelectorAll('.player-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById(`pc-${idx}`)?.classList.add('selected');
}

function triggerAccuse() {
  const sel = document.querySelector('.player-card.selected');
  if(!sel) { showToast('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ´Ğ»Ñ Ğ¾Ğ±Ğ²Ğ¸Ğ½ĞµĞ½Ğ¸Ñ','error'); return; }
  const idx = parseInt(sel.id.replace('pc-',''));
  const p = G.players[idx];
  const msg = `Ğ¯ Ğ¾Ğ±Ğ²Ğ¸Ğ½ÑÑ ${p.name}! ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ ÑĞ²Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ.`;
  document.getElementById('chatInput').value = msg;
  sendMessage();
  updateSuspicion(idx, 0.08, 'human_accuse');
}

function triggerDefend() {
  const msg = 'Ğ¯ Ğ½Ğµ Ğ¼Ğ°Ñ„Ğ¸Ñ! Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ ÑĞ¾ÑÑ€ĞµĞ´Ğ¾Ñ‚Ğ¾Ñ‡Ğ¸Ğ¼ÑÑ Ğ½Ğ° Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ….';
  document.getElementById('chatInput').value = msg;
  sendMessage();
}

function triggerClaim() {
  const me = G.players[G.humanIdx];
  const ri = ROLE_DISPLAY[me.role];
  const msg = me.role===ROLES.CIVILIAN ? 'Ğ¯ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ, Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ñƒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¼Ğ°Ñ„Ğ¸Ñ.' :
              me.role===ROLES.SHERIFF  ? 'ĞŸÑ€Ğ¸Ğ·Ğ½Ğ°ÑÑÑŒ â€” Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€. Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº.' :
              me.role===ROLES.DOCTOR   ? 'Ğ¯ Ğ´Ğ¾ĞºÑ‚Ğ¾Ñ€. Ğ—Ğ°Ñ‰Ğ¸Ñ‰Ğ°Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ½Ğ¾Ñ‡ÑŒ.' :
              'Ğ¯ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ…Ğ¾Ñ‡Ñƒ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ñ‚ÑŒ Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹.';
  document.getElementById('chatInput').value = msg;
  sendMessage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIN CONDITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkWinCondition() {
  const alive = G.players.filter(p=>!p.eliminated);
  const mafiaAlive = alive.filter(p=>p.role===ROLES.MAFIA).length;
  const civilAlive = alive.filter(p=>p.role!==ROLES.MAFIA).length;
  if(mafiaAlive === 0) { endGame('civil'); return true; }
  if(mafiaAlive >= civilAlive) { endGame('mafia'); return true; }
  return false;
}

function endGame(winner) {
  G.phase = PHASES.END;
  renderCounts();
  const isWin = (winner==='civil' && G.players[G.humanIdx].role!==ROLES.MAFIA) ||
                (winner==='mafia' && G.players[G.humanIdx].role===ROLES.MAFIA);
  const duration = Math.round((Date.now()-G.gameStartTime)/60000);

  document.getElementById('endTitle').textContent = isWin ? 'ğŸ† ĞŸĞĞ‘Ğ•Ğ”Ğ!' : 'ğŸ’€ ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ•';
  document.getElementById('endTitle').className = `end-title ${isWin?'win':'lose'}`;
  document.getElementById('endSubtitle').textContent = winner==='civil'
    ? 'Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ»! ĞœĞ°Ñ„Ğ¸Ñ ÑƒĞ½Ğ¸Ñ‡Ñ‚Ğ¾Ğ¶ĞµĞ½Ğ°.' : 'ĞœĞ°Ñ„Ğ¸Ñ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ¸Ğ»Ğ° Ğ³Ğ¾Ñ€Ğ¾Ğ´. Ğ¢ÑŒĞ¼Ğ° Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ»Ğ°.';

  document.getElementById('endStats').innerHTML = `
    <div class="end-stat"><div class="end-stat-val">${G.round}</div><div class="end-stat-label">Ğ Ğ°ÑƒĞ½Ğ´Ğ¾Ğ²</div></div>
    <div class="end-stat"><div class="end-stat-val">${duration}Ğ¼</div><div class="end-stat-label">Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ</div></div>
    <div class="end-stat"><div class="end-stat-val">${G.correctAccusations}</div><div class="end-stat-label">Ğ’ĞµÑ€Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ²Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹</div></div>`;

  document.getElementById('revealList').innerHTML = G.players.map(p=>{
    const ri = ROLE_DISPLAY[p.role];
    return `<div class="reveal-item">
      <span style="font-size:1rem">${p.avatar}</span>
      <span style="color:${p.color};font-size:0.8rem;font-weight:600">${p.name}</span>
      <span class="reveal-item-role" style="background:${ri.color}22;color:${ri.color};margin-left:auto">${ri.icon} ${ri.name}</span>
      ${p.eliminated?'<span style="font-size:0.65rem;color:var(--text-muted)">â€” Ğ²Ñ‹Ğ±Ñ‹Ğ»</span>':''}
    </div>`;
  }).join('');

  // Save stats
  const savedStats = JSON.parse(localStorage.getItem('mafiaStats')||'{"wins":0,"losses":0,"rounds":0}');
  if(isWin) savedStats.wins++; else savedStats.losses++;
  savedStats.rounds += G.round;
  localStorage.setItem('mafiaStats', JSON.stringify(savedStats));

  showScreen('end');
  if(isWin) speak('ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑÑ Ñ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¾Ğ¹! Ğ“Ğ¾Ñ€Ğ¾Ğ´ ÑĞ¿Ğ°ÑÑ‘Ğ½!');
  else speak('Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°. ĞœĞ°Ñ„Ğ¸Ñ Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ»Ğ°.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOW TO PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHowTo() {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;';
  overlay.innerHTML = `<div style="background:var(--bg-card);border:1px solid var(--border-bright);border-radius:12px;padding:32px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">
    <div style="font-family:var(--font-display);font-size:1.2rem;font-weight:800;color:var(--accent-red);margin-bottom:20px;">ĞšĞ°Ğº Ğ¸Ğ³Ñ€Ğ°Ñ‚ÑŒ</div>
    <div style="font-size:0.82rem;color:var(--text-secondary);line-height:1.8;">
      <b style="color:var(--text-primary)">ğŸ­ Ğ Ğ¾Ğ»Ğ¸:</b><br>
      ğŸ”« ĞœĞ°Ñ„Ğ¸Ñ â€” ÑƒĞ±Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ¾Ñ‡ÑŒÑ, Ğ¿Ñ€ÑÑ‡ĞµÑ‚ÑÑ Ğ´Ğ½Ñ‘Ğ¼<br>
      ğŸ‘¤ ĞœĞ¸Ñ€Ğ½Ñ‹Ğ¹ â€” Ğ¸Ñ‰ĞµÑ‚ Ğ¼Ğ°Ñ„Ğ¸Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼<br>
      ğŸ” ĞšĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ¾Ñ‡ÑŒÑ<br>
      ğŸ’‰ Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€ â€” Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚ ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²Ğ° Ğ½Ğ¾Ñ‡ÑŒÑ<br><br>
      <b style="color:var(--text-primary)">ğŸ“… Ğ¥Ğ¾Ğ´ Ğ¸Ğ³Ñ€Ñ‹:</b><br>
      ĞĞ¾Ñ‡ÑŒ â†’ ĞœĞ°Ñ„Ğ¸Ñ ÑƒĞ±Ğ¸Ğ²Ğ°ĞµÑ‚, Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚, ĞšĞ¾Ğ¼Ğ¸ÑÑĞ°Ñ€ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚<br>
      Ğ”ĞµĞ½ÑŒ â†’ Ğ’ÑĞµ Ğ¾Ğ±ÑÑƒĞ¶Ğ´Ğ°ÑÑ‚, Ğ³Ğ¾Ğ»Ğ¾ÑÑƒÑÑ‚, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ÑÑ‚ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ²Ğ°ĞµĞ¼Ğ¾Ğ³Ğ¾<br><br>
      <b style="color:var(--text-primary)">ğŸ† ĞŸĞ¾Ğ±ĞµĞ´Ğ°:</b><br>
      Ğ“Ğ¾Ñ€Ğ¾Ğ´: Ğ˜ÑĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ¼Ğ°Ñ„Ğ¸Ñ<br>
      ĞœĞ°Ñ„Ğ¸Ñ: Ğ§Ğ¸ÑĞ»ĞµĞ½Ğ½Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ÑÑ‚ÑŒÑÑ Ñ Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¼Ğ¸<br><br>
      <b style="color:var(--text-primary)">ğŸ’¡ Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹:</b><br>
      â€¢ ĞĞ°Ğ±Ğ»ÑĞ´Ğ°Ğ¹Ñ‚Ğµ Ğ·Ğ° Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ¾Ğ² â€” Ñƒ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑĞ²Ğ¾Ñ Ğ»Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ<br>
      â€¢ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ½Ğ¸Ğ¹ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸<br>
      â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞĞ±Ğ²Ğ¸Ğ½Ğ¸Ñ‚ÑŒ" Ğ¸ "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ¸Ñ‚ÑŒÑÑ" Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹<br>
      â€¢ ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ Ñ€ÑƒÑÑĞºĞ¸Ğ¼ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ñ€ĞµÑ‡Ğ¸
    </div>
    <button onclick="this.closest('div[style]').remove()" style="width:100%;margin-top:20px;background:var(--accent-red);border:none;color:white;font-family:var(--font-display);font-size:0.65rem;font-weight:700;letter-spacing:0.2em;padding:14px;cursor:pointer;border-radius:4px;">ĞŸĞĞĞ¯Ğ¢ĞĞ â†’</button>
  </div>`;
  document.body.appendChild(overlay);
}

function showStats() {
  const s = JSON.parse(localStorage.getItem('mafiaStats')||'{"wins":0,"losses":0,"rounds":0}');
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;';
  overlay.innerHTML = `<div style="background:var(--bg-card);border:1px solid var(--border-bright);border-radius:12px;padding:32px;max-width:400px;width:100%;text-align:center;">
    <div style="font-family:var(--font-display);font-size:1.2rem;font-weight:800;color:var(--accent-gold);margin-bottom:24px;">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
      <div style="background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;padding:16px;">
        <div style="font-family:var(--font-display);font-size:2rem;font-weight:800;color:var(--accent-green)">${s.wins}</div>
        <div style="font-size:0.65rem;color:var(--text-muted);margin-top:4px">ĞŸĞ¾Ğ±ĞµĞ´</div>
      </div>
      <div style="background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;padding:16px;">
        <div style="font-family:var(--font-display);font-size:2rem;font-weight:800;color:var(--accent-red)">${s.losses}</div>
        <div style="font-size:0.65rem;color:var(--text-muted);margin-top:4px">ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹</div>
      </div>
      <div style="background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;padding:16px;">
        <div style="font-family:var(--font-display);font-size:2rem;font-weight:800;color:var(--accent-gold)">${s.wins+s.losses>0?Math.round(s.wins/(s.wins+s.losses)*100):0}%</div>
        <div style="font-size:0.65rem;color:var(--text-muted);margin-top:4px">Ğ’Ğ¸Ğ½Ñ€ĞµĞ¹Ñ‚</div>
      </div>
    </div>
    <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:20px">Ğ’ÑĞµĞ³Ğ¾ Ğ¸Ğ³Ñ€: ${s.wins+s.losses} | Ğ’ÑĞµĞ³Ğ¾ Ñ€Ğ°ÑƒĞ½Ğ´Ğ¾Ğ²: ${s.rounds}</div>
    <div style="display:flex;gap:10px;">
      <button onclick="localStorage.removeItem('mafiaStats');this.closest('div[style]').remove();showToast('Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ğ°')" style="flex:1;background:transparent;border:1px solid var(--text-muted);color:var(--text-muted);font-family:var(--font-body);font-size:0.75rem;padding:10px;cursor:pointer;border-radius:4px;">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
      <button onclick="this.closest('div[style]').remove()" style="flex:2;background:var(--accent-red);border:none;color:white;font-family:var(--font-display);font-size:0.65rem;font-weight:700;letter-spacing:0.2em;padding:12px;cursor:pointer;border-radius:4px;">Ğ—ĞĞšĞ Ğ«Ğ¢Ğ¬</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(()=>{ showScreen('menu'); }, 2800);
  // Load voices
  if(synthesis) { synthesis.getVoices(); synthesis.onvoiceschanged = ()=>synthesis.getVoices(); }
  // Load settings from localStorage
  try {
    const saved = JSON.parse(localStorage.getItem('mafiaSettings')||'{}');
    if(saved.playerName) document.getElementById('playerName').value = saved.playerName;
  } catch(e){}
  // Save settings on change
  document.getElementById('playerName').addEventListener('input', e=>{
    localStorage.setItem('mafiaSettings', JSON.stringify({ playerName:e.target.value }));
  });
});
</script>
</body>
</html>
